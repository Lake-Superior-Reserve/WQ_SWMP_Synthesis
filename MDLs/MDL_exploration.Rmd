---
title: "MDL exploration"
output: html_document
date: "`r Sys.Date()`"
params: 
  dataType: "nut"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = TRUE)
```

Need to know some things......  

1.  What is the MDL for each parameter at each station  
2.  How does that MDL change through time - if big changes, how we handle it might look different than if they're just little "wiggles"  
3.  How are MDLs different between stations - will that matter? It might.  
4.  What proportion of the data is < MDL by station and..... month? Year? analytical time period of interest.....  
5.  And does that proportion change drastically over time (e.g. with big MDL changes, or for other reasons)  


```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(ggdist)
# library(patchwork)
library(plotly)
source(here::here("QAQC_flags", "functions.R"))

path <- here::here("Data_processing", "compiled_by_stn")
```

Flags indicating a sample was below detection:  

-  "<-4> [SBL]" - possibly with some C codes too  
-  "<-4>" would be simplest version of that  
-  "<4>" with "B": 4 for historical, B for below MDL  

```{r}
nut_parms <- c("chla_n", "po4f", 
              "nh4f", "no23f")
nut_keep <- c(nut_parms, paste0("f_", nut_parms))
names(nut_parms) <- paste0("val_", nut_parms)  # for easier pivoting later
```

```{r}
mstns <- readr::read_csv(here::here("sampling_stations.csv")) %>%  #read.csv threw an error for some reason
  janitor::clean_names() %>%   
  tidyr::separate(active_dates, into = c("start_date", "first_ end_date"),
                  sep = "-",
                  fill = "right",
                  extra = "drop") %>%  # only want the first date if there are multiples
  filter(lubridate::decimal_date(lubridate::my(start_date)) <= 2013.0,
         status == "Active")


# match up wq/nut intersection for stations that meet time length criteria
stns_wq <- str_sub(grep("wq$", mstns$station_code, value = TRUE),
                   end = -3)
stns_nut <- str_sub(grep("nut$", mstns$station_code, value = TRUE),
                   end = -4)
stns_wq_nut <- intersect(stns_wq, stns_nut)
```

```{r}
# check .RData files, only loop over stations that we have data for
fls <- dir(path, pattern = ".RData$")

toUse <- stns_wq_nut[paste0(stns_wq_nut, "wq.RData") %in% fls & paste0(stns_wq_nut, "nut.RData") %in% fls]

# subset during development
# toUse <- toUse[1:30]

# to avoid looping:
stn_vec <- toUse
stnnut <- paste0(toUse, "nut")
```

```{r, include = FALSE}
# have to generate a girafe object before looping to make the loop work
# this chunk will not appear in output, at all
p2 <- ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point()
ggplotly(p2)
```

## Read and combin nut data  

```{r}
nut <- purrr::map(stnnut, function(x) get(load(paste0(path, "/", x, ".RData")))) %>% 
  purrr::set_names(stn_vec) %>% 
  purrr::list_rbind(names_to = "stn") %>% 
  select(stn, datetimestamp, any_of(nut_keep)) %>% 
  rename(any_of(nut_parms)) %>% 
  rename(val_chlaN = val_chla_n,
         f_chlaN = f_chla_n) 

# pivot longer, remove rejected data, and extract flags
specnut <- nut %>% 
  build_longer_spec(
    cols = (starts_with("val_")[1]):ncol(nut),
    names_to = c(".value", "param"),
    names_sep = "_")
nut_long <- nut %>% 
  pivot_longer_spec(spec = specnut) %>% 
  mutate(Year = lubridate::year(datetimestamp),
         Month = lubridate::month(datetimestamp),
         Day = lubridate::mday(datetimestamp),
         reserve = str_sub(stn, 1, 3),
         flag = extract_flag(f),
         val = case_when(flag == "<-3>" ~ NA_real_,
                         .default = val),
         belowMDL = is_outsideMDL(f, "below"))

nut_long_nonchl <- nut_long %>% 
  filter(param != "chlaN")

nut_censored_nonchl <- nut_long %>% 
  filter(belowMDL == TRUE,
         param != "chlaN")
```

## Plots  

## MDLs through time  

MDLs through time. Can we show proportion < MDL on a 2nd axis?  

### raw  

```{r}
plot_mdl_time(nut_censored_nonchl, "no23f")
plot_mdl_time(nut_censored_nonchl, "nh4f")
plot_mdl_time(nut_censored_nonchl, "po4f")
```

### with non-censored data  

```{r}
plot_mdl_time(nut_censored_nonchl, "no23f", data_full = nut_long)
plot_mdl_time(nut_censored_nonchl, "nh4f", data_full = nut_long)
plot_mdl_time(nut_censored_nonchl, "po4f", data_full = nut_long)

plot_mdl_time(nut_censored_nonchl, "nh4f", data_full = nut_long) +
  coord_cartesian(ylim = c(0, 1))
```


## Overall mass of censored vs. not  

The following plots show the mass of values in a given range, and how many of them were flagged "below detection". Some reserves almost never have below detections for certain parameters (LOTS of pink to the right of the blue), and for other reserves, the values tend to mostly be at the low end, and flagged (when there's not much pink to the right of the blue).  

```{r}
plot_mdl_dens(nut_long, "no23f", xlim = c(0, 1))
plot_mdl_dens(nut_long, "nh4f", xlim = c(0, 0.5))
plot_mdl_dens(nut_long, "po4f", xlim = c(0, 0.5))
```


Another way to look at this overall is with boxplots. I've changed the scales on the parameters so the y-axis isn't so overwhelming compared to the MDLs.    

```{r}
plot_mdl_boxes(nut_long, "no23f", ylim = c(0, 0.1))
plot_mdl_boxes(nut_long, "nh4f", ylim = c(0, 0.1))
plot_mdl_boxes(nut_long, "po4f", ylim = c(0, 0.1))
```


## Distribution of MDL values  

The plots below won't let me give them a title, so the parameter is identified in the y-axis labe.  

```{r}
plot_mdl_weave(nut_censored_nonchl, "no23f")
plot_mdl_weave(nut_censored_nonchl, "nh4f")
plot_mdl_weave(nut_censored_nonchl, "po4f")
```


## Other, in progress  

```{r}

plot_mdl_dotinterval <- function(data, param, ylim = c(0, 1), ...){
  ggplot(data = filter({{data}}, param == {{param}})) +
    stat_dotsinterval(aes(x = belowMDL,
                     y = val)) +
    coord_cartesian(ylim = ylim) +
    facet_wrap(~reserve, ncol = 5) # +
    # labs(title = as.character(param),
    #      y = "value (mg/L)",
    #      x = "below detection?") 
}

plot_mdl_dotinterval(nut_long, "no23f", ylim = c(0, 0.1))

ggplot(filter(nut_long, param == "no23f"), 
       aes(x = belowMDL,
           y = val)) +
  stat_dotsinterval() +
  coord_cartesian(ylim = c(0, 0.1)) +
  facet_wrap(~reserve)

ggplot(filter(nut_long, param == "no23f"), 
       aes(x = belowMDL,
           y = val)) +
  stat_boxplot() +
  coord_cartesian(ylim = c(0, 0.1)) +
  facet_wrap(~reserve)

ggplot(filter(nut_long, param == "no23f")) +
  geom_density(aes(x = val,
                   y = ..scaled..,
                   fill = belowMDL),
               alpha = 0.3) +
  coord_cartesian(xlim = c(0, 0.25)) +
  facet_wrap(~reserve)



p <- ggplot(data = nut_censored_nonchl,
            aes(text = paste0(param,
                             ", ",
                             Year,
                             "-",
                             Month,
                             ": ",
                             val))) +
  geom_point(data = nut_long_nonchl, aes(x = datetimestamp,
                                         y = val),
             col = "gray80",
             alpha = 0.5)  +
  geom_point(data = nut_censored_nonchl, aes(x = datetimestamp,
                                             y = val),
             size = 2) +
  geom_line(data = nut_censored_nonchl, aes(x = datetimestamp,
                                            y = val)) +
  facet_grid(reserve ~ param, scales = "free") +
  labs(title = "Points flagged below MDL, overlaid on all readings",
       y = "value (mg/L)",
       x = "Date") +
  theme_bw()

ggplotly(p, tooltip = "text",
         width = 625, height = 675) 
```

