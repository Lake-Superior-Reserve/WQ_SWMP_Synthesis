---
title: "QAQC Flags and Codes"
output: 
  html_document:
    toc: true
    code_folding: hide
---

Code is present but hidden in this html file. To see code chunks, click on the "code" button on the right for the section you want to see.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE, warning = FALSE}
library(SWMPr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(stringr)
library(ggplot2)
library(kableExtra)
library(here)
library(data.table)
library(trend)
library(zoo)
library(lubridate)
source(here::here("QAQC_flags", "functions.R"))
```

# Read in data  

```{r}
stn <- "gndblwq"
#stn <- "lksbawq2012"


# hoping to eventually set this up to loop through all stations

dat <- import_local(path = here::here("Data"), 
                    station_code = stn, 
                    trace = TRUE,
                    collMethd = 1)  # grabs only - no ISCO if nutrient data

```

Turn any f_ columns that are only "" or that are NA into <-2>s (e.g. gndblwq cdepth in parts of 2014 and 2015 when there was no depth data, so no calculated values for cdepth, and an empty f_ column). Need to do this to all f_ columns.  

```{r}
# find the cols starting with f_
f_cols <- which(str_starts(names(dat), "f_"))

# loop through f_ cols and replace missing flags with <-2>
# using dplyr mutate and across removes the SWMPr object properties
# from the data frame, so have to loop
for(i in seq_along(f_cols)){
  col_ind <- f_cols[i]
  dat[, col_ind] <- replace_missing_flags(dat[, col_ind])
}
```


```{r warning=FALSE, echo=F, eval = FALSE}
#This code will loop to combine all csv's

data_path <- here("Data/Nutrients")

setwd(data_path)

NUT_data <-
  list.files(pattern = "*.csv") %>% 
  map_df(~read_csv(.))


data_path <- here("Data/WQ")

setwd(data_path)

WQ_data <-
  list.files(pattern = "*.csv") %>% 
  map_df(~read_csv(.))

```


# Make different data frames to work with  

## QAQC summary by flag/code and parameter  

from SWMPr package; no subsetting here - whole dataset  

```{r}
qaqc_summ <- qaqcchk(dat) |>
  tidyr::separate(flag, into = c("flag", "code"),
                  sep = " ",
                  extra = "merge",
                  fill = "right")
```

## QAQC summary; long  

still working off `SWMPr::qaqcchk()`  

```{r}
qaqcSumm_long <- qaqc_summ %>% 
  pivot_longer(-(1:2),
               names_to = "param",
               values_to = "count") %>% 
  mutate(flag = factor(flag)) %>% 
  group_by(flag, param) %>% 
  summarize(count = sum(count, na.rm = TRUE))
```



## QAQC columns *only*; wide  

Working off original data frame now  

```{r}
qaqc_only <- keep_onlyQAQC(dat)
```


## QAQC columns, all; long  

Pivoting the dataframe above; pulling out flag only (ignoring letter codes); assigning meanings based on numeric flags (probably should put these definitions in a function or different table or something).    
 

```{r}
qaqc_long <- qaqc_only %>% 
  mutate(Year = lubridate::year(datetimestamp),
         Month = lubridate::month(datetimestamp),
         Day = lubridate::mday(datetimestamp)) %>% 
  pivot_longer(cols = starts_with("f_"),
               names_to = "parameter",
               values_to = "flagCode") %>% 
  mutate(flag = extract_flag(flagCode),
         flag_detailed = case_match(flag,
                                    "<-5>" ~ "Above Detection Limit",
                                    "<-4>" ~ "Below Detection Limit",
                                    "<-3>" ~ "Rejected",
                                    "<-2>" ~ "Missing",
                                    "<-1>" ~ "Optional",
                                    "<0>" ~ "Passed QAQC",
                                    "<2>" ~ "Reserved for future use",
                                    "<1>" ~ "Suspect",
                                    "<3>" ~ "Calculated",
                                    "<4>" ~ "Historical",
                                    "<5>" ~ "Corrected",
                                    "" ~ "Missing",
                                    .default = "PROBLEM!"))

```

## Yearly/Monthly summary by flag  

From long data frame above. Creating both long and wide.    

### Monthly (Year-Month)  

```{r}
qaqc_monthly <- qaqc_long %>% 
  group_by(Year, Month, parameter, flag_detailed) %>% 
  tally()

qaqc_monthly_wide <- qaqc_monthly %>% 
  pivot_wider(names_from = parameter,
              values_from = n)
```

### Monthly - across all years  

```{r}
qaqc_monthly_allyrs <- qaqc_long %>% 
  group_by(Month, parameter, flag_detailed) %>% 
  tally()

qaqc_monthly_allyrs_wide <- qaqc_monthly_allyrs %>% 
  pivot_wider(names_from = parameter,
              values_from = n,
              values_fill = 0)

# slightly different table format  

# monthly_test <- qaqc_monthly_allyrs %>% 
#   pivot_wider(names_from = flag_detailed,
#               values_from = n)
# kable(monthly_test) %>% 
#   column_spec(column = 1:ncol(monthly_test), width = 10)
```



### Year  

```{r}
qaqc_yearly <- qaqc_long %>% 
  group_by(Year, parameter, flag_detailed) %>% 
  tally()

qaqc_yearly_wide <- qaqc_yearly %>% 
  pivot_wider(names_from = parameter,
              values_from = n,
              values_fill = 0)
```




# Summary tables  

## Overall, by parameter, with codes  

```{r}
qaqc_summ %>% 
  arrange(flag, code) %>% 
  kable() %>% 
  kable_material("striped") %>% 
  column_spec(1:2, width = 15) %>% 
  column_spec(3:ncol(qaqc_summ), width = 8) %>% 
  scroll_box(height = "400px", width = "600px")
```

## Monthly, with flags only  

Across all years  

```{r}
qaqc_monthly_allyrs_wide %>% 
  arrange(flag_detailed, Month) %>% 
  kable() %>% 
  kable_material("striped") %>% 
  column_spec(1:2, width = 15) %>% 
  column_spec(3:ncol(qaqc_summ), width = 8) %>% 
  scroll_box(height = "400px", width = "600px")
```

