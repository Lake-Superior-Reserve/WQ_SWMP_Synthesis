---
title: "QAQC Flags and Codes"
output: 
  html_document:
    toc: true
    code_folding: hide
---

Code is present but hidden in this html file. To see code chunks, click on the "code" button on the right for the section you want to see.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set up some key options for the file:  

-  parameters we want to focus on  
-  station to focus on (for development only; eventually will run this on all stations)  
-  flags to keep vs. not  

```{r}
key_params <- c("f_spcond", "f_sal", "f_do_pct",
                "f_do_mgl", 
                "f_nh4f", "f_no2f", "f_no3f", 
                "f_no23f", "f_po4f", "f_chla_n")

stn <- "gndblwq"
#stn <- "lksbawq2012"


# 'bad' flags - rejected or missing. 
flags_bad <- c("<-2>", "<-3>")

# threshold for minimum amount of useable data in a month
thresh <- 0.65
```



```{r, message = FALSE, warning = FALSE}
library(SWMPr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(stringr)
library(ggplot2)
library(kableExtra)
library(here)
library(data.table)
library(trend)
library(zoo)
library(lubridate)
source(here::here("QAQC_flags", "functions.R"))
```

# Read in data  

```{r}
# hoping to eventually set this up to loop through all stations

dat <- import_local(path = here::here("Data"), 
                    station_code = stn, 
                    trace = TRUE,
                    collMethd = 1)  # grabs only - no ISCO if nutrient data

```

Turn any f_ columns that are only "" or that are NA into <-2>s (e.g. gndblwq cdepth in parts of 2014 and 2015 when there was no depth data, so no calculated values for cdepth, and an empty f_ column). Need to do this to all f_ columns.  

```{r}
# find the cols starting with f_
f_cols <- which(str_starts(names(dat), "f_"))

# loop through f_ cols and replace missing flags with <-2>
# using dplyr mutate and across removes the SWMPr object properties
# from the data frame, so have to loop
for(i in seq_along(f_cols)){
  col_ind <- f_cols[i]
  dat[, col_ind] <- replace_missing_flags(dat[, col_ind])
}
```


```{r warning=FALSE, echo=F, eval = FALSE}
#This code will loop to combine all csv's

data_path <- here("Data/Nutrients")

setwd(data_path)

NUT_data <-
  list.files(pattern = "*.csv") %>% 
  map_df(~read_csv(.))


data_path <- here("Data/WQ")

setwd(data_path)

WQ_data <-
  list.files(pattern = "*.csv") %>% 
  map_df(~read_csv(.))

```


# Make different data frames to work with  

## QAQC summary by flag/code and parameter  

from SWMPr package; no subsetting here - whole dataset  

```{r}
qaqc_summ <- qaqcchk(dat) |>
  tidyr::separate(flag, into = c("flag", "code"),
                  sep = " ",
                  extra = "merge",
                  fill = "right")
```

## QAQC summary; long  

still working off `SWMPr::qaqcchk()`  

```{r, message = FALSE}
qaqcSumm_long <- qaqc_summ %>% 
  pivot_longer(-(1:2),
               names_to = "param",
               values_to = "count") %>% 
  mutate(flag = factor(flag)) %>% 
  group_by(flag, param) %>% 
  summarize(count = sum(count, na.rm = TRUE))
```



## QAQC columns *only*; wide  

Working off original data frame now  

```{r}
qaqc_only <- keep_onlyQAQC(dat)
```


## QAQC columns, all; long  

Pivoting the dataframe above; pulling out flag only (ignoring letter codes); assigning meanings based on numeric flags (probably should put these definitions in a function or different table or something).    
 

```{r}
qaqc_long <- qaqc_only %>% 
  mutate(Year = lubridate::year(datetimestamp),
         Month = lubridate::month(datetimestamp),
         Day = lubridate::mday(datetimestamp)) %>% 
  pivot_longer(cols = starts_with("f_"),
               names_to = "parameter",
               values_to = "flagCode") %>% 
  mutate(flag = extract_flag(flagCode),
         flag_detailed = case_match(flag,
                                    "<-5>" ~ "Above Detection Limit",
                                    "<-4>" ~ "Below Detection Limit",
                                    "<-3>" ~ "Rejected",
                                    "<-2>" ~ "Missing",
                                    "<-1>" ~ "Optional",
                                    "<0>" ~ "Passed QAQC",
                                    "<2>" ~ "Reserved for future use",
                                    "<1>" ~ "Suspect",
                                    "<3>" ~ "Calculated",
                                    "<4>" ~ "Historical",
                                    "<5>" ~ "Corrected",
                                    "" ~ "Missing",
                                    .default = "PROBLEM!"))

```

## Yearly/Monthly summary by flag  

From long data frame above. Creating both long and wide.    

### Monthly (Year-Month)  

```{r}
qaqc_monthly <- qaqc_long %>% 
  group_by(Year, Month, parameter, flag_detailed) %>% 
  tally()

qaqc_monthly_wide <- qaqc_monthly %>% 
  pivot_wider(names_from = parameter,
              values_from = n)
```

### Monthly - across all years  

```{r}
qaqc_monthly_allyrs <- qaqc_long %>% 
  group_by(Month, parameter, flag_detailed) %>% 
  tally()

qaqc_monthly_allyrs_wide <- qaqc_monthly_allyrs %>% 
  pivot_wider(names_from = parameter,
              values_from = n,
              values_fill = 0)

# slightly different table format  

# monthly_test <- qaqc_monthly_allyrs %>% 
#   pivot_wider(names_from = flag_detailed,
#               values_from = n)
# kable(monthly_test) %>% 
#   column_spec(column = 1:ncol(monthly_test), width = 10)
```



### Year  

```{r}
qaqc_yearly <- qaqc_long %>% 
  group_by(Year, parameter, flag_detailed) %>% 
  tally()

qaqc_yearly_wide <- qaqc_yearly %>% 
  pivot_wider(names_from = parameter,
              values_from = n,
              values_fill = 0)
```




# Summary tables  

## Overall, by parameter, with codes  

```{r}
qaqc_summ %>% 
  arrange(flag, code) %>% 
  kable() %>% 
  kable_material("striped") %>% 
  column_spec(1:2, width = 15) %>% 
  column_spec(3:ncol(qaqc_summ), width = 8) %>% 
  scroll_box(height = "400px", width = "600px")
```

## Monthly, with flags only  

Across all years  

```{r}
qaqc_monthly_allyrs_wide %>% 
  arrange(flag_detailed, Month) %>% 
  kable() %>% 
  kable_material("striped") %>% 
  column_spec(1:2, width = 15) %>% 
  column_spec(3:ncol(qaqc_summ), width = 8) %>% 
  scroll_box(height = "400px", width = "600px")
```


## Useable vs. missing/rejected  

Will make a table for each key parameter in the synthesis. Figure out the proportion of flags that are missing + rejected. If it is greater than 35% (meaning 65% of data are present and useable), the table cell should turn red.  

Would also like to illustrate this by heat maps, maybe....  


Filter out key parameters to only what's in the current dataset  

```{r}
key_params <- key_params[key_params %in% names(dat)]
```


```{r, message = FALSE}
qaqc_simplified <- qaqc_long %>% 
  filter(parameter %in% key_params) %>%
  mutate(flag_status = case_when(flag %in% flags_bad ~ "Missing or Rejected",
                                 .default = "Useable")) %>% 
  group_by(parameter, Year, Month) %>% 
  summarize(Useable = sum(flag_status == "Useable"),
            Missing_or_Rejected = sum(flag_status == "Missing or Rejected")) %>% 
  mutate(Proportion_useable = round(Useable / (Useable + Missing_or_Rejected), 4),
         Status = case_when(Proportion_useable >= thresh ~ "Good",
                            .default = "Bad"))
  
```

## Graph  

Really we'll want to do this by station, for a single parameter.  

```{r, fig.width = 7, fig.height = 8}
cols <- c("Good" = "gray90",
          "Bad" = "red3"
          )

ggplot(qaqc_simplified) +
  geom_tile(aes(x = Month, y = Year, fill = Status)) +
  facet_wrap(~parameter, ncol = 1, scales = "free") +
  scale_fill_manual(values = cols) +
  labs(title = "Thresholds for monthly data",
       subtitle = paste0("Bad means that < ", thresh*100, "% of values within a month-year \nwere useable (not rejected or missing)"))
```

