---
title: "`r paste('Simple plots of qa/qc flagging:', params$dataType)`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
date: "`r Sys.Date()`"
params:
  dataType: "nut"
  reportType: "simple"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)

library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
# library(patchwork)
library(plotly)
source(here::here("QAQC_flags", "functions.R"))
```

# About this html file  

-  Code is present, but folded. If you want to unfold a portion of code, click on the `code` button on the right.  
-  This file was made by using 2 files - This main one is RMarkdown, and for each station, a `.R` script is called to do all the same things (at the moment, just making graphs).      
-  Updated 6/27/23; rather than going station-by-station, will go through groups of 10 stations at a time so graphs can be facted by param x station.  
-  Add'l update 6/27/23: new AQS download of all SWMP WQ and NUT stations, from 2002 - 2022.  


# About the graphs  

-  Hover over bars on the plot to see additional information.  
    -  a "useable" day was defined as a day where at least one data point was flagged okay, below/above detection, historical, or corrected.  
    -  a "bad" day was a day where there were 0 data points in the above flags.  
-  Plots are interactive in other ways too - try zooming in on a certain time frame along the x-axis, for example, if you want more detail.  



# Parameter choices  

In this section we can define which flags and parameters to keep.  

<details>  

Currently set to keep:  

-  Flags:  
    -  0 - accepted  
    -  4 - historical  
    -  -4 - below detection  
    -  -5 - above detection
    -  5 - corrected  
    -  <1> [GIT] - data recovered from telemetry  
    -  2 and 3; per readme in data download: "2 and 3 Flags were used in 2007 and 2008 to designate data that were outside 2 and 3 standard deviations from the historical seasonal mean. This automated check has since been discontinued and the 2 and 3 flags applied to the data during this time are being removed from the dataset as the data are authenticated."  
-  WQ Parameters:  
    -  Temp  
    -  SpCond  
    -  Sal  
    -  DO %  
    -  DO mg/L  
-  NUT Parameters:  
    -  Chl a (as `chla_n` - does this show up with other names from other reserves?)  
    -  PO4_f (f = filtered)  
    -  NH4_f
    -  NO23_f
 
    
NO2 and NO3 as separate parameters were removed 7/10/23 after discussion at the Data Analysis Team meeting on 6/30.  
    
</details>

```{r, cache = TRUE}
# path to data; change this when files get moved to a better location
path <- here::here("Data_processing", "compiled_by_stn")
```

```{r, cache = TRUE}
# define which flags to keep
flags_keep <- c("<0>", "<4>", "<-4>", "<5>", "<-5>", "<2>", "<3>")
flagCodes_keep <- c("<1> \\[GIT\\]")  # Use \\ for parentheses and square brackets.   

flagCodes_keepvec <- paste(flagCodes_keep, collapse = "|")

# define which wq parameters to investigate
wq_parms <- c("temp", "spcond", "sal",
             "do_pct", "do_mgl")
wq_keep <- c(wq_parms, paste0("f_", wq_parms))
names(wq_parms) <- paste0("val_", wq_parms)  # for easier pivoting later


# define which nut parameters to investigate
nut_parms <- c("chla_n", "po4f", 
              "nh4f", "no23f")
nut_keep <- c(nut_parms, paste0("f_", nut_parms))
names(nut_parms) <- paste0("val_", nut_parms)  # for easier pivoting later

```

# Available Stations  

Here I'm keeping stations that:  

-  have both WQ and NUT parameters associated with the same station name  
-  are currently active  
-  have a start date in or before 2013 (at least 10 years)  

```{r, cache = TRUE}
# for now pulling data from Data_processing subfolder but 
# eventually it will live in the main 'data' folder

mstns <- readr::read_csv(here::here("sampling_stations.csv")) %>%  #read.csv threw an error for some reason
  janitor::clean_names() %>%   
  tidyr::separate(active_dates, into = c("start_date", "first_ end_date"),
                  sep = "-",
                  fill = "right",
                  extra = "drop") %>%  # only want the first date if there are multiples
  filter(lubridate::decimal_date(lubridate::my(start_date)) <= 2013.0,
         status == "Active")


# match up wq/nut intersection for stations that meet time length criteria
stns_wq <- str_sub(grep("wq$", mstns$station_code, value = TRUE),
                   end = -3)
stns_nut <- str_sub(grep("nut$", mstns$station_code, value = TRUE),
                   end = -4)
stns_wq_nut <- intersect(stns_wq, stns_nut)

# cleanup  
rm(mstns, stns_nut, stns_wq)
```

**`r length(stns_wq_nut)` stations** throughout the reserve system meet these criteria:  *`r paste(stns_wq_nut, collapse = ", ")`*.  

# Graphs   

```{r}
# check .RData files, only loop over stations that we have data for
fls <- dir(path, pattern = ".RData$")

toUse <- stns_wq_nut[paste0(stns_wq_nut, "wq.RData") %in% fls & paste0(stns_wq_nut, "nut.RData") %in% fls]
```

```{r}
# subset during development
toUse <- toUse[1:30]
```

```{r, include = FALSE}
# have to generate a girafe object before looping to make the loop work
# this chunk will not appear in output, at all
p2 <- ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point()
ggplotly(p2)
```


```{r, eval = TRUE, echo = TRUE, results = 'asis'}
# turn this on to work with groups of ~ 10 stations  

x <- toUse
n <- length(toUse) %/% 10  # number of groups for them to mostly contain 10 stations
split_stns <- split(x, cut(seq_along(x), breaks = n, labels = FALSE))

for(i in seq_along(split_stns)){
  stn_vec <- split_stns[[i]]
  stnwq <- paste0(stn_vec, "wq")
  stnnut <- paste0(stn_vec, "nut")
  
  cat(paste("\n\nGroup", i, "of", length(split_stns), ": \n", paste(stn_vec, collapse = ", "), "\n\n"))
 
  if(params$reportType == "full"){
    try(source(here::here("QAQC_flags", "counting_forloop_innards_byGroup.R")))
  } 
  
    if(params$reportType == "simple"){
    try(source(here::here("QAQC_flags", "simple_forloop_innards_byGroup.R")))
  } 

}
```



```{r, eval = FALSE, echo = FALSE, results = 'asis', fig.width = 7, fig.height = 5}
# turn this chunk on to go station-by-station

for(st in toUse){

  try(source(here::here("QAQC_flags", "counting_forloop_innards.R")))

}
```

