---
title: ""
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      fig.height = 5,
                      fig.width = 7)

library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(ggiraph)
source(here::here("QAQC_flags", "functions.R"))
```

# About this html file  

-  Code is present, but folded. If you want to unfold a portion of code, click on the `code` button on the right.  
-  This file was made by using 2 rmarkdown files - one as a 'parent', and one called a 'child' that is called as many times as I need it to be - i.e., for each parameter. So the code chunks will mostly look the same because it's just the same ones being called over and over again.    


# Days with data  

-  Hover over bars on the plot to see the Year/Month and # days of {useable/bad} data points.  
    -  a "useable" day was defined as a day where at least one data point was flagged okay, below detection, historical, or corrected.  
    -  a "bad" day was a day where there were 0 data points in the above flags.  
    -  I find the "bad" days easier to spot problems in, which is why I put it first.... but open to input.  



### Parameter choices  

```{r}
# path to data; change this when files get moved to a better location
path <- here::here("Data_processing", "compiled_by_stn")
```

```{r}
# define which flags to keep: currently just 0, 4, -4, 5
flags_keep <- c("<0>", "<4>", "<-4>", "<5>")

# define which wq parameters to investigate
wq_parms <- c("temp", "spcond", "sal",
             "do_pct", "do_mgl")
wq_keep <- c(wq_parms, paste0("f_", wq_parms))
names(wq_parms) <- paste0("val_", wq_parms)  # for easier pivoting later


# define which nut parameters to investigate
nut_parms <- c("chla_n", "po4f", 
              "nh4f", "no23f", 
              "no2f", "no3f")
nut_keep <- c(nut_parms, paste0("f_", nut_parms))
names(nut_parms) <- paste0("val_", nut_parms)  # for easier pivoting later

```

### Available Stations  

```{r}
# go through each of the WQ+NUT stations
# that meet certain criteria:
# currently active, with start date in or before 2011
# both wq and nut at same station
# for now pulling data from Data_processing subfolder but 
# eventually it will live in the main 'data' folder

mstns <- readr::read_csv(here::here("sampling_stations.csv")) %>%
  janitor::clean_names() %>%   #read.csv threw an error for some reason
  tidyr::separate(active_dates, into = c("start_date", "first_ end_date"),
                  sep = "-",
                  fill = "right",
                  extra = "drop") %>%  # only want the first date if there are multiples
  filter(lubridate::decimal_date(lubridate::my(start_date)) <= 2011.0,
         status == "Active")

# match up wq/nut intersection for stations that meet time length criteria
stns_wq <- str_sub(grep("wq$", mstns$station_code, value = TRUE),
                   end = -3)
stns_nut <- str_sub(grep("nut$", mstns$station_code, value = TRUE),
                   end = -4)


stns_wq_nut <- intersect(stns_wq, stns_nut)

# cleanup  
rm(mstns, stns_nut, stns_wq)
```

# Graphs by station  

Loop through each station to produce graphs (and stats if needed)  

```{r}
# check .RData files, only loop over stations that we have data for
fls <- dir(path, pattern = ".RData$")

toUse <- stns_wq_nut[paste0(stns_wq_nut, "wq.RData") %in% fls & paste0(stns_wq_nut, "nut.RData") %in% fls]

toUse <- toUse[1:5]


for(st in toUse){

  source(here::here("QAQC_flags", "counting_forloop_innards.R"))
  
}
```
