---
title: "`r toupper(params$reserve)` Time Series Graphs"
date: "generated `r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    toc_depth: 2
params:
  reserve: "gnd"
---

# About this file  

These are time series graphs of monthly data for all required SWMP parameters at your reserve, going back to 2002 [or each station's start date, if it was later than 2002]. Only stations labelled "Active" as of 8/29/2023 in the `sampling_stations` csv that accompanies CDMO downloads are included here, but all stations are present in the dataset.   

## How to navigate this document  

On the left is a floating table of contents for navigating between major sections of output:  

-  Water Quality  
-  Weather    
-  Nutrients    
-  Nutrients with log-10 y-axis   

When you click on one of those headers, or scroll down the document, the floating table of contents will expand to reveal the individual parameters within each section. Parameter naming is generally the same as in the CDMO's SWMP database, though all have been changed to lower case and underscores (_) have been replaced by dashes (-).  


## Plot layout and interactivity  

*Hovering over a point* on any plot will bring up a bubble showing the date (really just year-month, with an arbitrary day value of 15), the value of the parameter, and other identifying information (min/median/max; censored or not). You can *zoom in* by clicking and dragging your mouse to highlight an interesting area within a graph panel. When you *hover over any part of a graph*, a toolbar will pop up in the upper right corner, and you can reset the axes (zoom back out), use other zoom options, and even save the plot as an image file. 

**WQ and MET** plots each consist of two columns, with one row for each station. The left column contains monthly minimum and maximum values, with median values in the right column.  

**NUT** plots also contain two columns, but the columns are not meaningful. There is simply one panel for each station. Because nutrient data can have high outliers, plots are provided with both a regular y-axis and a log-10 y-axis.    

**Please make sure all values and ranges look reasonable. Also make sure there aren't any data gaps that you didn't expect.** Remember gaps can be caused not just by missing data, but by data flagged suspect or rejected.    

## How data were processed and aggregated  

The CDMO's Advanced Query System Zip download was used to download data from all SWMP stations for 2002 - 2022. This download contained a single file for each station, for each year. Files for each station were combined, with **only grab samples** kept from nutrient files (no diel samples). Then any data points flagged and coded in ways the NERRS Synthesis work group decided to discard were discarded. Typically this included any points flagged as suspect or rejected. Finally, these QA/QC'd data files were aggregated to monthly frequency in the following ways:  

-  **WQ and MET** - from the valid (not discarded) 15-minute readings, minimum, median, and maximum were calculated and are shown here for most parameters. Exceptions are total precipitation, where valid readings were summed to monthly totals; and PAR, where 15-minute readings were summed for each day, and the daily values were summarized as minimum, median, and maximum.  
-  **NUT** - valid monthly replicate values were averaged. During file processing, a column was added for each nutrient to indicate whether that value had been censored (e.g. was below detection), based on the QA/QC flags and codes. In the monthly aggregation, if at least one valid replicate was identified as censored, the average was also identified as censored. Points on the nutrient plots are colored by whether or not this average was censored.  

More detail is available on request!  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      fig.width = 7,
                      fig.height = 7)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(plotly)
```

```{r, include = FALSE}
# generate a ggplotly object before loops to make loops work
p2 <- ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length)) +
  geom_point()
ggplotly(p2)
```


```{r active-stations}
mstns <- readr::read_csv(here::here("helper_files", "sampling_stations.csv")) %>%  #read.csv threw an error for some reason
  janitor::clean_names() %>%   
  filter(status == "Active")

stns_active <- mstns %>% 
  mutate(station_code = stringr::str_squish(station_code)) %>% 
  pull(station_code)
```


```{r load-data}
path <- here::here("Data", "QAQCd_monthly_byType")

# wq
load(here::here(path, "SWMP_monthlyWQ.RData"))
wq$reserve <- substr(wq$station, start = 1, stop = 3)

# met
load(here::here(path, "SWMP_monthlyMET.RData"))
met$reserve <- substr(met$station, start = 1, stop = 3)

# nut
load(here::here(path, "SWMP_monthlyNUT.RData"))
nut$reserve <- substr(nut$station, start = 1, stop = 3)
```

```{r renaming-specs}
col_matching <- c("do-mgl_min" = "do_mgl_min",
                  "do-mgl_median" = "do_mgl_median",
                  "do-mgl_max" = "do_mgl_max",
                  "do-pct_min" = "do_pct_min",
                  "do-pct_median" = "do_pct_median",
                  "do-pct_max" = "do_pct_max",
                  "chla_val" = "chla_n",
                  "chla_cens" = "chla_n_cens",
                  "po4f_val" = "po4f",
                  "nh4f_val" = "nh4f",
                  "no2f_val" = "no2f",
                  "no3f_val" = "no3f",
                  "no23f_val" = "no23f")
```

# Water Quality  

```{r subset-wq-data}
# filter: keep only this reserve, and active stations
# select: identifying columns and min/median/max; no empty columns
# rename to remove extra underscores
dat <- wq %>% 
  filter(reserve == params$reserve,
         station %in% stns_active) %>% 
  select(station, year, month, ends_with("min"), ends_with("median"), ends_with("max")) %>% 
  remove_empty("cols") %>% 
  rename(any_of(col_matching))

# pivot
dat_long <- dat %>% 
  pivot_longer(4:ncol(dat),
               names_to = c("param", "stat"),
               names_sep = "_",
               values_to = "value") %>% 
  # pivot_wider(names_from = stat,
  #             values_from = value) %>% 
  mutate(date = lubridate::ymd(paste(year, month, "15", sep = "-")),
         stat2 = case_when(stat %in% c("min", "max") ~ "min.max",
                           stat == "median" ~ "median",
                           .default = stat),
         stat2 = forcats::fct_relevel(stat2, "min.max", "median"),
         stat = forcats::fct_relevel(stat, "min", "median", "max"))
```

```{r, results = "asis"}
parms <- unique(dat_long$param)
for(i in seq_along(parms)){
  cat("\n")
  cat("##", parms[i], "\n")
  dat_sub <- filter(dat_long, param == parms[i])
  p <- ggplot(dat_sub, aes(x = date, y = value, col = stat)) +
    geom_line(linewidth = 0.3) +
    geom_point(size = 0.6) +
    facet_grid(station ~ stat2) +
    theme_bw() +
    theme(legend.position = "top",
          legend.justification = "left",
          legend.margin = margin(c(0,0,0,0))) +
    labs(x = "Date",
         y = "value",
         col = "")
  
  ggplotly(p,
           width = 675, height = 675) %>%  
    layout(legend = list(orientation = "h",
                         y = 1.11, x = 0)) %>% 
    htmltools::tagList() %>%
    print()
  
  # print(p)
  cat("\n")
}
```



```{r loop-through-wq-parms, results = "asis"}
# parms <- unique(dat_long$param)
# for(i in seq_along(parms)){
#   cat("\n")
#   cat("##", parms[i], "\n")
#   dat_sub <- filter(dat_long, param == parms[i])
#   p <- ggplot(dat_sub, aes(x = date, y = median)) +
#     geom_line(aes(col = "median")) +
#     geom_line(aes(y = min, col = "min")) +
#     geom_line(aes(y = max, col = "max")) +
#     facet_wrap(~station) +
#     theme_bw() +
#     theme(legend.position = "none") +
#     labs(title = paste(parms[i], "monthly min/median/max"),
#          x = "Date",
#          y = "value")
#   print(p)
#   cat("\n")
# }
```


# Weather  

```{r subset-met-data}
# filter: keep only this reserve
# select: identifying columns and min/median/max; no empty columns
# rename to remove extra underscores
dat <- met %>% 
  filter(reserve == params$reserve,
         station %in% stns_active) %>% 
  select(station, year, month, ends_with("min"), ends_with("median"), ends_with("max"), ends_with("total")) %>% 
  remove_empty("cols") %>% 
  rename(any_of(col_matching))

# pivot
dat_long <- dat %>% 
  pivot_longer(4:ncol(dat),
               names_to = c("param", "stat"),
               names_sep = "_",
               values_to = "value") %>% 
  mutate(date = lubridate::ymd(paste(year, month, "15", sep = "-")),
         stat2 = case_when(stat %in% c("min", "max") ~ "min.max",
                           stat == "median" ~ "median",
                           .default = stat),
         stat2 = forcats::fct_relevel(stat2, "min.max", "median"),
         stat = forcats::fct_relevel(stat, "min", "median", "max"))
```

```{r loop-through-met-parms, results = "asis", fig.height = 4, fig.width = 7}
parms <- unique(dat_long$param)
parms <- parms[-which(parms == "totprcp")] # precip treated differently, below loop

for(i in seq_along(parms)){
  cat("\n")
  cat("##", parms[i], "\n")
  
  dat_sub <- filter(dat_long, param == parms[i])
  p <- ggplot(dat_sub, aes(x = date, y = value, col = stat)) +
    geom_line(linewidth = 0.3) +
    geom_point(size = 0.6) +
    facet_grid(station ~ stat2) +
    theme_bw() +
    theme(legend.position = "top",
          legend.justification = "left",
          legend.margin = margin(c(0,0,0,0))) +
    labs(x = "Date",
         y = "value",
         col = "")
  
    ggplotly(p,
           width = 675, height = 350) %>%  
    layout(legend = list(orientation = "h",
                         y = 1.25, x = 0)) %>% 
    htmltools::tagList() %>%
    print()
    
  cat("\n")
  
}

cat("\n")
cat("##", "totprcp", "\n")
dat_sub <- filter(dat_long, param == "totprcp")
p <- ggplot(dat_sub, aes(x = date, y = value)) +
  geom_line(col = "navy", linewidth = 0.3) +
  geom_point(col = "navy", size = 0.6) +
  facet_wrap(~station, ncol = 1) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Date",
       y = "value")

ggplotly(p,
           width = 675, height = 350) %>%  
    layout(legend = list(orientation = "h",
                         y = 1.11, x = 0)) %>% 
    htmltools::tagList() %>%
    print()

cat("\n")
```


# Nutrients  

```{r subset-nut-data}
# filter: keep only this reserve, and active stations
# select: identifying columns and min/median/max; no empty columns
# rename to remove extra underscores
dat <- nut %>% 
  filter(reserve == params$reserve,
         station %in% stns_active) %>% 
  remove_empty("cols") %>% 
  rename(any_of(col_matching))

# pivot
dat_long <- dat %>% 
  select(-reserve) %>% 
  pivot_longer(4:ncol(.),
               names_to = c("param", "info"),
               names_sep = "_",
               values_to = "value") %>% 
  pivot_wider(names_from = info,
              values_from = value) %>% 
  mutate(date = lubridate::ymd(paste(year, month, "15", sep = "-")),
         cens = case_when(cens == 1 ~ "yes",
                          cens == 0 ~ "no",
                          .default = as.character(cens)),
         val = round(val, 4)) %>% 
  rename("value" = "val")
```

```{r loop-through-nut-parms, results = "asis"}
parms <- unique(dat_long$param)
for(i in seq_along(parms)){
  cat("\n")
  cat("##", parms[i], "\n")
  dat_sub <- filter(dat_long, param == parms[i])
  p <- ggplot(dat_sub, aes(x = date, y = value, col = cens)) +
    geom_line(col = "gray60", alpha = 0.7, linewidth = 0.3) +
    geom_point(alpha = 0.6, size = 1) +
    facet_wrap(~station, ncol = 2) +
    theme_bw() +
    theme(legend.position = "top",
          legend.justification = "left",
          legend.margin = margin(c(0,0,0,0))) +
    labs(x = "Date",
         y = "value",
         col = "below detection")
  
  ggplotly(p,
           width = 675, height = 450) %>%  
    layout(legend = list(orientation = "h",
                         y = 1.18, x = 0)) %>% 
    htmltools::tagList() %>%
    print()
  
  cat("\n")
}
```


# Nutrients - log scale  


```{r loop-through-nut-parms2, results = "asis"}
parms <- unique(dat_long$param)
for(i in seq_along(parms)){
  cat("\n")
  cat("##", parms[i], "\n")
  dat_sub <- filter(dat_long, param == parms[i])
  p <- ggplot(dat_sub, aes(x = date, y = value, col = cens)) +
    geom_line(col = "gray60", alpha = 0.6, linewidth = 0.3) +
    geom_point(alpha = 0.7, size = 1) +
    facet_wrap(~station, ncol = 2) +
    scale_y_log10() +
    theme_bw() +
    theme(legend.position = "top",
          legend.justification = "left",
          legend.margin = margin(c(0,0,0,0))) +
    labs(x = "Date",
         y = "value",
         col = "below detection")
  
  ggplotly(p,
           width = 675, height = 450) %>%  
    layout(legend = list(orientation = "h",
                         y = 1.18, x = 0)) %>% 
    htmltools::tagList() %>%
    print()
  
  cat("\n")
}
```