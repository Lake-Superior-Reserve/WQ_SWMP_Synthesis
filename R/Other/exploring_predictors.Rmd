---
title: "Exploration of Predictor Variables"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 8.5,
                      fig.width = 8)

# packages
library(tidyverse)
library(GGally) # for ggpairs
library(corrplot) # for corrplot


# parameters and columns to keep
params_wq <- c("temp_median", "spcond_median", 
               "turb_median")
params_nut <- c("chla_n", "chla_n_cens",
                "nh4f", "nh4f_cens",
                "no23f", "no23f_cens",
                "po4f", "po4f_cens")
params_met <- c("atemp_median", "wspd_median",
                "maxwspd_median", "totprcp_total",
                "dailyPAR_median")
params_trends <- c("temp_median", "spcond_median", "turb_median",
                   "chla_n", "po4f", "nh4f", "no23f",
                   "atemp_median", "dailyPAR_median",
                   "sqrt_precp_total")


```

```{r}
preds_all <- read.csv(here::here("Data", "compiled_predictors.csv"))
```


# Correlation plots  

```{r}
Q <- cor(preds_all[4:ncol(preds_all)], 
         method = "spearman",
         use = "pairwise.complete.obs")
testRes = cor.mtest(preds_all[4:ncol(preds_all)], conf.level = 0.95)
```

## All  

Used Spearman method for correlation calculation  

Variables are ordered by their loadings on PC1 of a PCA (`order = 'FPC'`)  

**Significant correlations are marked with an asterisk**  

```{r}
corrplot(Q, 
         type = "upper",
         order = 'FPC',
         method = "ellipse",
         p.mat = testRes$p, 
         sig.level = 0.05,
         insig = "label_sig",
         pch.cex = 2.5,
         pch.col = "gray20",
         tl.pos = "lt",
         tl.cex = 0.8,
         tl.srt = 45)
corrplot(Q, add = TRUE,
         type = "lower",
         order = 'FPC',
         method = "number",
         insig = "n",
         diag = FALSE,
         tl.pos = "n",
         cl.pos = "n")
```



## Significant only  

```{r}
corrplot(Q, 
         type = "full",
         order = 'FPC',
         method = "ellipse",
         p.mat = testRes$p, 
         sig.level = 0.05,
         addCoef.col = "gray30",
         insig = "blank",
         tl.pos = "lt",
         tl.cex = 0.8,
         tl.srt = 45)
```



# Pairs plots  

Pretty hard to look at; trying my best.  

Log-transforming medians of chl and nutrients first due to their distn's (this would not change spearman correlations calculated above)  

```{r}
preds_all2 <- preds_all |> 
  mutate(across(c(chla_n_median, nh4f_median, no23f_median, po4f_median),
                function(x) log10(x)))
```

```{r, fig.height = 11, fig.width = 15}
lowerFn <- function(data, mapping, method = "loess", ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(colour = "navy", alpha = 0.8) +
    geom_smooth(method = method, color = "darkorange", 
                se = FALSE, linewidth = 0.9, ...)
  p
}

ggpairs(preds_all2[4:ncol(preds_all2)],
        upper = list(continuous = "cor", method = "spearman"),
        lower = list(continuous = wrap(lowerFn)),
        axisLabels = "none")
```


```{r, fig.height = 11, fig.width = 15}
pairs(preds_all2[, 4:ncol(preds_all2)],
      lower.panel = panel.smooth,
      upper.panel = NULL)
```






# One big PCA  

## Importance of axes  

```{r}
pca_out <- prcomp(Q)
pca_summ <- summary(pca_out)

summary(pca_out)$importance[, 1:6]
```

First 3 axes get us up to 77% of variance explained.  

## Loadings:  

### First 4  

(ordered by PC1, as were the corrplots above)  

The first PC axis is all about the weather variables and latitude. I haven't interpreted beyond that.  

```{r}
first_pcs <- as.data.frame(summary(pca_out)$rotation[, 1:4])

first_pcs |> arrange(desc(PC1))
```


### PC1  

```{r}
first_pcs |> 
  select(PC1) |> 
  arrange(desc(PC1))
```



### PC2  

```{r}
first_pcs |> 
  select(PC2) |> 
  arrange(desc(PC2))
```


### PC3  

```{r}
first_pcs |> 
  select(PC3) |> 
  arrange(desc(PC3))
```



