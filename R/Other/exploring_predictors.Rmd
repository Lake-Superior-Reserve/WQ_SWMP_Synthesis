---
title: "Exploration of Predictor Variables"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 8.5,
                      fig.width = 8)

# packages
library(tidyverse)
library(GGally) # for ggpairs
library(corrplot) # for corrplot
library(car)


# parameters and columns to keep
params_wq <- c("temp_median", "spcond_median", 
               "turb_median")
params_nut <- c("chla_n", "chla_n_cens",
                "nh4f", "nh4f_cens",
                "no23f", "no23f_cens",
                "po4f", "po4f_cens")
params_met <- c("atemp_median", "wspd_median",
                "maxwspd_median", "totprcp_total",
                "dailyPAR_median")
params_trends <- c("temp_median", "spcond_median", "turb_median",
                   "chla_n", "po4f", "nh4f", "no23f",
                   "atemp_median", "dailyPAR_median",
                   "sqrt_precp_total")


```

```{r}
preds_all <- read.csv(here::here("Data", "compiled_predictors.csv"))
```


# Correlation plots  

```{r}
Q <- cor(preds_all[4:ncol(preds_all)], 
         method = "spearman",
         use = "pairwise.complete.obs")
testRes = cor.mtest(preds_all[4:ncol(preds_all)], conf.level = 0.95)
```

## All  

Used Spearman method for correlation calculation  

Variables are ordered by their loadings on PC1 of a PCA (`order = 'FPC'`)  

**Significant correlations are marked with an asterisk**  

```{r}
corrplot(Q, 
         type = "upper",
         order = 'FPC',
         method = "ellipse",
         p.mat = testRes$p, 
         sig.level = 0.05,
         insig = "label_sig",
         pch.cex = 2.5,
         pch.col = "gray20",
         tl.pos = "lt",
         tl.cex = 0.8,
         tl.srt = 45)
corrplot(Q, add = TRUE,
         type = "lower",
         order = 'FPC',
         method = "number",
         insig = "n",
         diag = FALSE,
         tl.pos = "n",
         cl.pos = "n",
         number.cex = 0.6)
```



## Significant only  

```{r}
corrplot(Q, 
         type = "full",
         order = 'FPC',
         method = "ellipse",
         p.mat = testRes$p, 
         sig.level = 0.05,
         addCoef.col = "gray30",
         insig = "blank",
         tl.pos = "lt",
         tl.cex = 0.8,
         tl.srt = 45,
         number.cex = 0.6)
```



# Pairs plots  

Pretty hard to look at; trying my best. There is a pdf with all of the individual plots.    

Log-transforming medians of chl and nutrients first due to their distn's (this would not change spearman correlations calculated above)  

```{r}
preds_all2 <- preds_all |> 
  mutate(across(c(chla_n_median, nh4f_median, no23f_median, po4f_median),
                function(x) log10(x)))
```

```{r, fig.height = 11, fig.width = 15}
lowerFn <- function(data, mapping, method = "loess", ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(colour = "navy", alpha = 0.8) +
    geom_smooth(method = method, color = "darkorange", 
                se = FALSE, linewidth = 0.9, ...)
  p
}

ggpairs(preds_all2[4:ncol(preds_all2)],
        upper = list(continuous = "cor", method = "spearman"),
        lower = list(continuous = wrap(lowerFn)),
        axisLabels = "none")
```

Save pairs plots as a pdf so they're actually visible. (note, playing with smooths and using GAM below. Was LOESS above.)  This includes all pairs in both configurations - I didn't fight it so you can find your favorite parameter on either axis as you scan through. That means there are 650 plots in the document below.

```{r}
# https://stackoverflow.com/a/59243423

df <- preds_all2 |> 
  select(-reserve, -station, -met_station)

# create all combinations of different variable names
nms <- list(x = names(df), 
            y = names(df)) %>% 
  cross_df() %>% 
  filter(x != y)

# create list of all the scatter plots
plts <- map2(.x = nms$x, 
             .y = nms$y,
             ~{ggplot(data = df, 
                      aes_string(x = .x, 
                                 y = .y)) +
                 geom_point(col = "navy",
                            alpha = 0.8) +
                 geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs"), 
                             color = "darkorange", 
                             se = FALSE, linewidth = 0.9)}
)

# create multi-page pdf with the figures
ggsave("pairs-plots-extended.pdf", 
       gridExtra::marrangeGrob(grobs = plts, 
                               nrow = 5, 
                               ncol = 3),
       device = "pdf", 
       width = 210, 
       height = 297, 
       units = "mm")
```


# VIFs of chl model  

What happens if we throw in all the predictors?  

Center and scale (z-score; everything but chla trends) to avoid issues with different scales. Also log-transform nutrient medians first.  

```{r, fig.height = 5, fig.width = 7}
df_for_chla <- preds_all |> 
  select(-reserve, -station, -met_station) |> 
  mutate(across(c(chla_n_median, nh4f_median, no23f_median, po4f_median),
                function(x) log10(x+0.001))) |> 
  mutate(across(c(temp_trend:turb_trend, po4f_trend:precp_trend),
                function(x) scale(x)))

chla_mod <- lm(chla_trend ~ .,
               data = df_for_chla)

# plot(chla_mod)
# i'm pretty happy with the diagnostic plots

# vif(chla_mod)
# YIKES

modvif <- as.data.frame(vif(chla_mod)) |> 
  rownames_to_column("predictor") |> 
  rename(VIF = `vif(chla_mod)`) |> 
  arrange(VIF) |> 
  mutate(predictor = fct_inorder(predictor))


ggplot(modvif) +
  geom_col(aes(x = VIF, y = predictor),
           fill = "cadetblue3") +
  geom_vline(xintercept = 5, linetype = "dashed", 
             col = "red3",
             size = 1,
             alpha = 0.8) +
  geom_text(aes(x = VIF, y = predictor,
                label = round(VIF, 1)),
            hjust = 1.1,
            col = "black",
            size = rel(3)) +
  labs(title = "VIFs for chla_trend ~ all predictors below")

```

**BIG YIKES**  

Get rid of things that are pretty clearly redundant, like:  

-  max wind speed median  
-  air temp median  
-  latitude  

```{r, fig.height = 5, fig.width = 7}
df2 <- df_for_chla |> 
  select(-maxwspd_median,
         -atemp_median,
         -latitude)

mod2 <- lm(chla_trend ~ .,
               data = df2)

# plot(mod2)
# still pretty happy

# vif(mod2)
# YIKES

modvif <- as.data.frame(vif(mod2)) |> 
  rownames_to_column("predictor") |> 
  rename(VIF = `vif(mod2)`) |> 
  arrange(VIF) |> 
  mutate(predictor = fct_inorder(predictor))


ggplot(modvif) +
  geom_col(aes(x = VIF, y = predictor),
           fill = "cadetblue3") +
  geom_vline(xintercept = 5, linetype = "dashed", 
             col = "red3",
             size = 1,
             alpha = 0.8) +
  geom_text(aes(x = VIF, y = predictor,
                label = round(VIF, 1)),
            hjust = 1.1,
            col = "black",
            size = rel(3)) +
  labs(title = "VIFs for chla_trend ~ all predictors below")
```

Still lots of yikes.  



# One big PCA  

## Importance of axes  

```{r}
pca_out <- prcomp(Q)
pca_summ <- summary(pca_out)

summary(pca_out)$importance[, 1:6]
```

26 axes total.  

First 3 axes get us up to 77% of variance explained. 4th gets us to 86%.  

```{r, fig.height = 3, fig.width = 5}
screeplot(pca_out, type = "lines")
```

From the screeplot, looks like ~4 or 5 is a good amount of axes to use.  

Note that these would not be very interpretable as predictors in another model.  


## Loadings:  

### First 5  

(ordered by PC1, as were the corrplots above)  

The first PC axis is all about the weather variables and latitude. I haven't interpreted beyond that.  

```{r}
first_pcs <- as.data.frame(summary(pca_out)$rotation[, 1:5])

first_pcs |> arrange(desc(PC1))
```


### PC1  

```{r}
first_pcs |> 
  select(PC1) |> 
  arrange(desc(PC1))
```



### PC2  

```{r}
first_pcs |> 
  select(PC2) |> 
  arrange(desc(PC2))
```


### PC3  

```{r}
first_pcs |> 
  select(PC3) |> 
  arrange(desc(PC3))
```


### PC4  

The strong PO4-trend/NH4-trend correlation doesn't show up strongly until axis 4.  

```{r}
first_pcs |> 
  select(PC4) |> 
  arrange(desc(PC4))
```


### PC5  


```{r}
first_pcs |> 
  select(PC5) |> 
  arrange(desc(PC5))
```