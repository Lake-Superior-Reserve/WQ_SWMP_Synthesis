---
title: "Seasonality quantification"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = TRUE,
                      fig.width = 7,
                      fig.height = 7)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)

source(here::here("helper_files", "definitions.R"))
source(here::here("helper_files", "functions.R"))

load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))

region_dictionary <- read.csv(here::here("helper_files",
                                         "region_dictionary.csv"))

wq <- wq |> 
  mutate(do_proportion_below2 = round(doLessThan2_total / doLessThan2_nValid, 4),
         do_proportion_below5 = round(doLessThan5_total / doLessThan5_nValid, 4)) 
```


# About 

These graphs imitate Figure 3 in Cloern and Jassby 2008. The plot on the left is the timing (month) of the parameter maximum (chl a; DO time below 2 and 5 mg/L) or minimum (DO % and mg/L). The plot on the right is normalized amplitude: annual range divided by annual mean.  

Open blue circles are each individual point, and red points represent the overall median for the station. This got complicated for timing (many station/year combinations had 2-3 months with the same 'peak' value, and I attempted to weight these) so do not consider these final calculations, only preliminary.  



# Chl a (peak)  

```{r}
chl_annual <- annualize(nut, chla_n) |> 
  select(-annual_min, -floor_month) |> 
  rename(key_stat = annual_max,
         key_month = peak_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

chl_timing <- timing_calcs(chl_annual)

time_ampl_plots(chl_timing, chl_annual, "Chl a", "peak")
```

```{r, fig.width = 7, fig.height = 5}
chl_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

chl_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
chl_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

chl_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```


# DO %  (min) 

```{r}
dopct_annual <- annualize(wq, do_pct_median) |> 
  select(-annual_max, -peak_month) |> 
  rename(key_stat = annual_min,
         key_month = floor_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

dopct_timing <- timing_calcs(dopct_annual)

time_ampl_plots(dopct_timing, dopct_annual, "DO % saturation", "minimum")
```


```{r, fig.width = 7, fig.height = 5}
dopct_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

dopct_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
dopct_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

dopct_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```


# DO mg/L (min)  

```{r}
domgl_annual <- annualize(wq, do_mgl_median) |> 
  select(-annual_max, -peak_month) |> 
  rename(key_stat = annual_min,
         key_month = floor_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

domgl_timing <- timing_calcs(domgl_annual)

time_ampl_plots(domgl_timing, domgl_annual, "DO mg/L", "minimum")
```

```{r, fig.width = 7, fig.height = 5}
domgl_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

domgl_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
domgl_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

domgl_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```




# proportion DO < 5 (max)  

```{r}
doLessThan5_annual <- annualize(wq, do_proportion_below5) |> 
  select(-annual_min, -floor_month) |> 
  rename(key_stat = annual_max,
         key_month = peak_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

do5_timing <- timing_calcs(doLessThan5_annual)

time_ampl_plots(do5_timing, doLessThan5_annual, "Proportion of DO < 5 mg/L", "peak")
```

```{r, fig.width = 7, fig.height = 5}
do5_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

do5_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
doLessThan5_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

doLessThan5_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```


# proportion DO < 2 (max)  

```{r}
doLessThan2_annual <- annualize(wq, do_proportion_below2) |> 
  select(-annual_min, -floor_month) |> 
  rename(key_stat = annual_max,
         key_month = peak_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

do2_timing <- timing_calcs(doLessThan2_annual)

time_ampl_plots(do2_timing, doLessThan2_annual, "Proportion of DO < 2 mg/L", "peak")
```

```{r, fig.width = 7, fig.height = 5}
do2_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

do2_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
doLessThan2_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

doLessThan2_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```


# Temperature (max)  

Max is somewhat arbitrary, but I think if we did 'min' we would miss the true minimum at sites that pull sondes for winter.  


```{r}
wtemp_annual <- annualize(wq, temp_median) |> 
  select(-annual_min, -floor_month) |> 
  rename(key_stat = annual_max,
         key_month = peak_month) |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve"))

wtemp_timing <- timing_calcs(wtemp_annual)

time_ampl_plots(wtemp_timing, wtemp_annual, "Water Temperature", "peak")
```

```{r, fig.width = 7, fig.height = 5}
wtemp_timing$most_likely_month |> 
  ggplot() +
  geom_histogram(aes(x = median_month),
                 fill = "blue3",
                 col = "gray80",
                 bins = 12) +
  theme(legend.position = "none") +
  labs(title = "timing overall",
       x = "median month")

wtemp_timing$most_likely_month |> 
  mutate(reserve = stringr::str_sub(station, start = 1, end = 3)) |> 
  left_join(region_dictionary, by = c("reserve" = "Reserve")) |> 
  ggplot() +
  geom_histogram(aes(x = median_month,
                     fill = Region),
                 col = "gray80",
                 bins = 12) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "timing by region",
       x = "median month")
```

```{r, fig.width = 7, fig.height = 5}
wtemp_annual |> 
  summarize(.by = station,
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl),
                 fill = "blue3",
                 col = "gray80",
                 bins = 20) +
  theme(legend.position = "none") +
  labs(title = "median normalized amplitude, overall",
       x = "normalized amplitude")

wtemp_annual |> 
  summarize(.by = c(Region, station),
            median_norm_ampl = median(an_normalized_amplitude)) |> 
  ggplot() +
  geom_histogram(aes(x = median_norm_ampl,
                     fill = Region),
                 col = "gray80",
                 bins = 15) +
  facet_wrap(~Region, scales = "free_y") +
  theme(legend.position = "none") +
  labs(title = "amplitude by region",
       x = "median normalized amplitude")
```


# Concatenate all  

This data frame contains one row per station per year. Columns contain the max/min for the year; month or months of the annual max/min (depending on parameter); the amplitude for that year (max - min); and the normalized amplitude for that year (amplitude / that year's mean).

```{r}
all_seasonal_metrics <- list("chl max" = chl_annual, 
                             "dopct min" = dopct_annual, 
                             "domgl min" = domgl_annual,
                             "wtemp max" = wtemp_annual, 
                             "doLessThan2 max" = doLessThan2_annual,
                             "doLessThan5 max" = doLessThan5_annual) |> 
  purrr::list_rbind(names_to = "param") |> 
  separate(param, into = c("parameter", "seasonal_metric"), sep = " ") |> 
  mutate(parameter = case_match(parameter, # to match up with parameter names in calculated trends data frame
                                "chl" ~ "chla_n",
                                "dopct" ~ "do_pct_median",
                                "domgl" ~ "do_mgl_median",
                                "wtemp" ~ "temp_median",
                                "doLessThan2" ~ "do_proportion_below2",
                                "doLessThan5" ~ "do_proportion_below5"))


seasonal_by_stn <- all_seasonal_metrics |> 
  summarize(.by = c(parameter, seasonal_metric, station),
            median_ampl = median(annual_amplitude),
            median_norm_ampl = median(an_normalized_amplitude))

save(seasonal_by_stn, file = here::here("Outputs", 
                "calculated_trends", "seasonal_characterization.RData"))
```



# Some explanation  

From Cloern and Jassby 2008:

1.  Monthly mean chl calculated (will use our monthly values)  
2.  Annual mean determined by averaging monthly means  
    a.  They only did this when all 12 values existed in a calendar year, or when there were 12 consecutive months of data. I don't think this will work for our purposes especially given some sites not sampling in winter months. 
    b.  Probably ought to make some cutoff though to get a legitimate yearly average.  
    c.  **I used a cutoff of 6 months within each year**  
3.  Defined the month number of the largest monthly mean, within each year.  
4.  Turned that into a probability distribution: "a site with three years of data and annual peaks in March, April and March respectively would have a distribution with March set to 0.67, April to 0.33 and other months to 0."  
    a.  so essentially each month's number is the proportion of available years in which that month had the peak chl.  
5.  Turned the probability dist'n into a frequency dist'n across all sites within a region - which we are not doing.  
6.  Amplitude: (max - min) for each year. This is "highly dependent on the overall biomass level as expressed by the annual mean" so they also normalized: range divided by annual mean.  
    a.  I don't see whether/how they calculated an overall amplitude - guess we'll take the average of whatever amplitudes are available? Could also use median (I believe this is what I did in the figures)  
    b.  Normalizing was useful for chl a. They did not work with the other parameters we've used here. I made a few plots and believe chl a is probably the only parameter we should normalize.  
    c.  Both normalized and raw amplitudes are included in the output data frame.  
    

I'll start by only calculating these for chl (max), DO (min), and DO proportions (max).  

Sometimes there are multiple peaks within a year so the `peak_month` (month or months containing the maximum reading for the year) and `floor_month` (month or months containing the minimum reading for the year) columns are list columns.  

Need to unlist the column and then assign weights for each month of the year (so in years with only one month of a peak, the weight for the month going into the next weighting will be 1; when there are 3 peaks, each month's weight will be 0.33, etc.)
    
```{r}
# does normalizing amplitude help?
ampl_plots <- function(dat, param){
  x <- dat
  p1 <- ggplot(x, aes(x = annual_mean, 
                      y = annual_amplitude, col = Region)) + 
    geom_point()
  p2 <- ggplot(x, aes(x = annual_mean, y = 
                        an_normalized_amplitude, col = Region)) + 
    geom_point()
  
  p1 + p2 + 
    plot_layout(guides = "collect") +
    plot_annotation(title = param)
}

ampl_plots(wtemp_annual, "water temp")  # does nothing
ampl_plots(chl_annual, "Chl a")  # removes an association
ampl_plots(dopct_annual, "DO % saturation")  # hm, sort of a negative association. variability doesn't seem to change though. - more so once normalized, but y limits are 2 orders of magnitude lower
ampl_plots(domgl_annual, "DO mg/L") # weird outlier amplitude, but otherwise doesn't seem like standardization is needed
ampl_plots(filter(domgl_annual, annual_amplitude < 50), "DO mg/L") # okay, unnecessary to normalize, but doesn't seem to hurt
ampl_plots(doLessThan2_annual, "DO < 2mg/L") # huh, actually seems to replace one association with another, and makes the y-axis BIGGER
ampl_plots(doLessThan5_annual, "DO < 5mg/L") # huh, actually seems to replace one association with another
# for the DO proportions, it's probably more important to NOT normalize, actually
```
    
    
