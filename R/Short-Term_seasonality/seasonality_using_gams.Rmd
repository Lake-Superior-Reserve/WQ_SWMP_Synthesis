---
title: "Seasonality explorations"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(mgcv)
library(gratia)

source(here::here("helper_files", "functions.R"))
```


This file is meant to explore whether, at least for long-term stations wherre we have run GAMs, the timing of the chl max matches up with a simpler way of calculating timing (generate an "average" max for each year - if there are multiple months with the same max, average them. then average that from all the years. similar to Cloern and Jassby 2008 but simpler.). The simpler method is probably what we should use for general characterization of seasonality, since we will also be including short-term stations. I will also explore the use of GAMs to determine whether the seasonality is changing, for long-term stations. As for amplitude..... we should probably keep the simple calculations that have already been performed, because GAMs are using log-chla as a response, which is less interpretable. It could be interesting though to see whether exponentiating that amplitude is similar to the normalized amplitude we get from Cloern and Jassby's method.  

# Read in data  

```{r}
# general trends and slopes; has a column for whether the seasonal term in the GAM was significant
load(here::here("Outputs", "calculated_trends", "long-term-trends.RData"))

# seasonal amplitudes (raw and normalized)
# these were calculated in R/Short-Term_seasonality/seasonality_viz.Rmd
load(here::here("Outputs", "calculated_trends", "seasonal_characterization.RData"))


```

I think I need to load in some bam output and raw data too. bam outputs are saved by station/parameter combo so I'll do some data exploration first to figure out which bam output I should load and play with. But I'll start with gndbhnut.   

```{r}
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
load(here::here("Outputs", "calculated_trends", "bam_outputs",
                "gndbhnut_chla_n_bam.RData"))  # named bam_out
gndbhchl <- bam_out$dat_bam
```

# Timing  

Look at BH chl seasonality from gam:

```{r}
plot(gndbhchl)

sort(gndbhchl$coefficients)
```

Looks like October and September have the largest coefficients. September edges out October overall but not by much - we have kind of a wide peak from Aug-Oct.  

Don't just use the coefficients though; predict and see what happens. Maybe there's a larger difference in the predictions than in the coefficients.  

```{r}
newdat <- data.frame(year = rep(2020, 12),
                     month = 1:12)
newdat <- newdat |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)),
         dec_date = lubridate::decimal_date(date))
pred <- predict(gndbhchl, newdata=newdat)
newdat$pred <- pred

plot(pred ~ dec_date, data = newdat, type = "b")

newdat |> arrange(desc(pred))
```

Yikes, October wins here, with November very close to it.  



What do we get from the "simpler" method?  

```{r}
bhchl_raw <- nut |> 
  filter(station == "gndbhnut") |> 
  select(station, year, month, chla_n, chla_n_cens)

bhchl_ann <- annualize(bhchl_raw, chla_n) |> # note this is not grouped by station but probably should be
  mutate(mean_peak_month = as.numeric(map(peak_month, mean, na.rm = TRUE)),
         mean_floor_month = as.numeric(map(floor_month, mean, na.rm = TRUE)),
         median_peak_month = as.numeric(map(peak_month, median, na.rm = TRUE)),
         median_floor_month = as.numeric(map(floor_month, median, na.rm = TRUE)))
```

```{r}
ggplot(bhchl_ann) +
  geom_point(aes(y = year, x = mean_peak_month, col = "mean"),
             alpha = 0.4) +
  geom_point(aes(y = year, x = median_peak_month, col = "median"),
             alpha = 0.4) +
  scale_x_continuous(breaks = scales::pretty_breaks())
```

in this case at least, mean and median are all the same. They're not for floor_month though so let me play with that (even though we're not interested in that metric for chl a)  

```{r}
ggplot(bhchl_ann) +
  geom_point(aes(y = year, x = mean_floor_month, col = "mean"),
             alpha = 0.4) +
  geom_point(aes(y = year, x = median_floor_month, col = "median"),
             alpha = 0.4) +
  scale_x_continuous(breaks = scales::pretty_breaks())
```

Overall means and medians:  

```{r}
bhchl_ann |> 
  summarize(.by = station,
            overall_mean_peak = mean(mean_peak_month, na.rm = TRUE),
            overall_medianOfMedians_peak = median(median_peak_month, na.rm = TRUE),
            overall_medianOfMeans_peak = median(mean_peak_month, na.rm = TRUE),
            overall_mean_floor = mean(mean_floor_month, na.rm = TRUE),
            overall_medianOfMedians_floor = median(median_floor_month, na.rm = TRUE),
            overall_medianOfMeans_floor = median(mean_floor_month, na.rm = TRUE)) |> 
  knitr::kable()
```

We have a difference of a month for peak if we use means vs. medians, in the case of this station. Looks like a few early maxes are pulling the mean - I feel better about medians because of this. Also, looks like (at least for this station), the median of annual medians matches the median of annual means, and I feel good about that.  

Closest match to what I pulled from the gam is overall median peak of 8.5, closest to the max coefficient for smooth month from month 9.  OH RIGHT, also, the gam is working with logs..... though it's a monotonic transformation, but the seasonal pattern might look a little different because the variation in magnitude isn't as high.  

How about I run the annualize function and those summaries on all the stations, and plot a few of them against each other.  

## calcs for all stations  

```{r}
chl_ann <- annualize(nut, chla_n) |> 
  mutate(mean_peak_month = as.numeric(map(peak_month, mean, na.rm = TRUE)),
         mean_floor_month = as.numeric(map(floor_month, mean, na.rm = TRUE)),
         median_peak_month = as.numeric(map(peak_month, median, na.rm = TRUE)),
         median_floor_month = as.numeric(map(floor_month, median, na.rm = TRUE)))

chl_summ <- chl_ann |> 
  summarize(.by = station,
            overall_mean_peak = mean(mean_peak_month, na.rm = TRUE),
            overall_medianOfMedians_peak = median(median_peak_month, na.rm = TRUE),
            overall_medianOfMeans_peak = median(mean_peak_month, na.rm = TRUE),
            overall_mean_floor = mean(mean_floor_month, na.rm = TRUE),
            overall_medianOfMedians_floor = median(median_floor_month, na.rm = TRUE),
            overall_medianOfMeans_floor = median(mean_floor_month, na.rm = TRUE)) 
  
```

```{r}
ggplot(chl_summ) +
  geom_abline(slope = 1, intercept = 0,
              col = "gray40",
              linetype = "dashed") +
  geom_point(aes(x = overall_medianOfMedians_peak,
                 y = overall_mean_peak,
                 col = "mean of annual means"),
             alpha = 0.5) +
  geom_point(aes(x = overall_medianOfMedians_peak,
                 y = overall_medianOfMeans_peak,
                 col = "median of annual means"),
             alpha = 0.8) +
  labs(title = "month of chl a peak",
       x = "Overall median of annual median peak months",
       y = "Other way of calculating metric")
```

Mean of means has a lot more variation than the median. And the median of means vs. median of annual medians looks like it's pretty much exactly 1:1.  

Now check it on DO:  

```{r}
domgl_ann <- annualize(wq, do_mgl_median) |> 
  mutate(mean_peak_month = as.numeric(map(peak_month, mean, na.rm = TRUE)),
         mean_floor_month = as.numeric(map(floor_month, mean, na.rm = TRUE)),
         median_peak_month = as.numeric(map(peak_month, median, na.rm = TRUE)),
         median_floor_month = as.numeric(map(floor_month, median, na.rm = TRUE)))

domgl_summ <- domgl_ann |> 
  summarize(.by = station,
            overall_mean_peak = mean(mean_peak_month, na.rm = TRUE),
            overall_medianOfMedians_peak = median(median_peak_month, na.rm = TRUE),
            overall_medianOfMeans_peak = median(mean_peak_month, na.rm = TRUE),
            overall_mean_floor = mean(mean_floor_month, na.rm = TRUE),
            overall_medianOfMedians_floor = median(median_floor_month, na.rm = TRUE),
            overall_medianOfMeans_floor = median(mean_floor_month, na.rm = TRUE))

ggplot(domgl_summ) +
  geom_abline(slope = 1, intercept = 0,
              col = "gray40",
              linetype = "dashed") +
  geom_point(aes(x = overall_medianOfMedians_floor,
                 y = overall_mean_floor,
                 col = "mean of annual means"),
             alpha = 0.5) +
  geom_point(aes(x = overall_medianOfMedians_floor,
                 y = overall_medianOfMeans_floor,
                 col = "median of annual means"),
             alpha = 0.8) +
  labs(title = "month of DO mg/L min",
       x = "Overall median of annual median min months",
       y = "Other way of calculating metric")
```


Mean tends to skew earlier for month of DO min. This probably means.... it is skewed. So maybe mean is better than median???  


# Changes in seasonality  

## gndbhnut chl  

First look at a time series plot.  

```{r}
bhchl_raw |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)),
         dec_date = lubridate::decimal_date(date)) |> 
  ggplot(aes(x = dec_date, y = chla_n)) +
  geom_point() +
  geom_line()
```

Oh I need to log-transform it though don't I, to get a normal dist'n.  

```{r}
bhchl2 <- bhchl_raw |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)),
         dec_date = lubridate::decimal_date(date),
         log_chla = log10(chla_n))

ggplot(bhchl2, aes(x = dec_date, y = log_chla)) +
  geom_point() +
  geom_line()
```

GAM it up. Not dealing with autocorrelation or censoring at this point, just getting my feet under me.  

```{r}
m1 <- gam(log_chla ~ s(month, bs = "cc", k = 12) + s(dec_date),
          data = bhchl2)
summary(m1)
draw(m1)
draw(m1, residuals = TRUE)
appraise(m1)

m2 <- gam(log_chla ~ ti(dec_date) + ti(month) + ti(dec_date, month),
          data = bhchl2)
summary(m2)
appraise(m2)

month_smooth <- smooth_estimates(m2, smooth = "ti(month)")
ggplot(month_smooth) +
  geom_ribbon(aes(x = month, ymin = est - 2*se, ymax = est + 2*se),
              fill = "gray80") +
  geom_line(aes(x = month, y = est)) +
  labs(title = "partial effect of month")


draw(m2) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  labs(x = "year-month")
draw(m2, contour = FALSE)
```


### interaction term plus good graphs  

```{r}
m3 <- gam(log_chla ~ s(year) + s(month) + ti(month, year),
          data = bhchl2)
summary(m3)
appraise(m3)

draw(m3) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(y = "year-month")
```


#### first vs. last year seasonal cycles  

```{r}
newdat <- data.frame(year = c(rep(min(bhchl2$year), length(unique(bhchl2$month))),
                              rep(max(bhchl2$year), length(unique(bhchl2$month)))),
                     month = c(sort(unique(bhchl2$month)), sort(unique(bhchl2$month)))
) |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)))
preds <- predict.gam(m3, newdata = newdat, se.fit = TRUE)
newdat$preds = preds$fit
newdat$se = preds$se.fit

ggplot(newdat) +
  geom_ribbon(aes(x = month, ymin = preds - 2*se, 
                  ymax = preds + 2*se,
                  fill = as.factor(year)),
              alpha = 0.1) +
  geom_line(aes(x = month, y = preds, col = as.factor(year)),
            linewidth = 1) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(title = "gndbhnut",
       y = "predicted log(chl)",
       fill = "Year",
       color = "Year")
```


```{r}
newdat2 <- newdat |> 
  select(-date, -se) |> 
  mutate(year = case_when(year == max(year) ~ "end",
                          year == min(year) ~ "start")) |> 
  pivot_wider(names_from = year,
              values_from = preds) |> 
  mutate(change = end - start)

ggplot(newdat2, aes(x = month, y = change)) +
  geom_point() +
  scale_x_continuous(breaks = scales::pretty_breaks())
```

### peak through time  

Visualize.  

Also, it might not necessarily be a trend; especially because months are sort of categorical. Maybe this would be a good use of a Mann-Kendall test?  

```{r}
p <- ggplot(bhchl_ann) +
  geom_point(aes(x = year, y = median_peak_month)) +
  geom_hline(yintercept = median(bhchl_ann$median_peak_month, na.rm = TRUE),
             col = "gray40",
             linetype = "dashed") +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  labs(title = "chl peak months by year",
       subtitle = "dashed line is overall median",
       y = "peak month")

p
```

Yikes. We sort of see more above the line in later years, so maybe the peak is getting a little later??  If we only do this for chl and do, we probably don't need to worry about censoring. Any other nutrient I'd worry about.  

```{r}
timing_mk <- EnvStats::kendallTrendTest(median_peak_month ~ year, data = bhchl_ann)
timing_mk$estimate
timing_mk$p.value

timing_mk2 <- with(bhchl_ann, Kendall::Kendall(x = year, y = median_peak_month))
timing_mk2
# doesn't give a slope

mkslopes <- timing_mk$estimate 
p +
  geom_abline(slope = mkslopes["slope"], intercept = mkslopes["intercept"]) +
  labs(subtitle = "black line is Kendall trend")
```

```{r}
test <- data.frame(value = c(2, 1, 3, 2, 1, 8, 7, 9, 8, 8),
                   year = 2011:2020)
test_mk <- EnvStats::kendallTrendTest(value ~ year, data = test)
mkslopes2 <- test_mk$estimate
test_mk$p.value

ggplot(test, aes(x = year, y = value)) +
  geom_point() +
  geom_abline(slope = mkslopes2["slope"], intercept = mkslopes2["intercept"]) +
  labs(title = "Simulated data",
       subtitle = paste0("trend p-val = ", round(test_mk$p.value, 3)))
```


### normalized amplitude by year  

```{r}
ggplot(bhchl_ann) +
  geom_point(aes(x = year, y = an_normalized_amplitude)) +
  labs(y = "normalized amplitude")
```

A few years have pretty big amplitudes. Is there a trend?  

```{r}
ampl_mk <- EnvStats::kendallTrendTest(an_normalized_amplitude ~ year, data = bhchl_ann)
ampl_mk$estimate
ampl_mk$p.value
```

Visually decreasing a bit, but not a significant p-value from a Kendall trend test.  

I feel more okay about using a Kendall trend test for amplitude than for timing.  



## lksolnut chl  


```{r}
stn = "lksolnut"

chl_dat <- nut |> 
  filter(station == stn) |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)),
         dec_date = lubridate::decimal_date(date),
         log_chla = log10(chla_n))

chl_seas <- chl_ann |> 
  filter(station == stn)
```

First look at a time series plot.  

```{r}
ggplot(chl_dat, aes(x = dec_date, y = chla_n)) +
  geom_point() +
  geom_line() +
  labs(title = paste0("time series of chl at ", stn))
```


```{r}
ggplot(chl_dat, aes(x = dec_date, y = log_chla)) +
  geom_point() +
  geom_line() +
  labs(title = paste0("time series of log10-chl at ", stn))
```


### interaction term plus good graphs  

```{r}
m3 <- gam(log_chla ~ s(year) + s(month) + ti(month, year),
          data = chl_dat)
summary(m3)
appraise(m3)

draw(m3) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(y = "year-month")
```

No significant month x year interaction.  


#### first vs. last year seasonal cycles  

```{r}
newdat <- data.frame(year = c(rep(min(chl_dat$year), length(unique(chl_dat$month))),
                              rep(max(chl_dat$year), length(unique(chl_dat$month)))),
                     month = c(sort(unique(chl_dat$month)), sort(unique(chl_dat$month)))
) |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)))
preds <- predict.gam(m3, newdata = newdat, se.fit = TRUE)
newdat$preds = preds$fit
newdat$se = preds$se.fit

ggplot(newdat) +
  geom_ribbon(aes(x = month, ymin = preds - 2*se, 
                  ymax = preds + 2*se,
                  fill = as.factor(year)),
              alpha = 0.1) +
  geom_line(aes(x = month, y = preds, col = as.factor(year)),
            linewidth = 1) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("seasonality in first and last years at ", stn),
       y = "predicted log(chl)",
       fill = "Year",
       color = "Year")
```

No big visual change here.  


```{r}
newdat2 <- newdat |> 
  select(-date, -se) |> 
  mutate(year = case_when(year == max(year) ~ "end",
                          year == min(year) ~ "start")) |> 
  pivot_wider(names_from = year,
              values_from = preds) |> 
  mutate(change = end - start)

ggplot(newdat2, aes(x = month, y = change)) +
  geom_point() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("change between first and last years at ", stn, " by month"))
```

### peak through time  

Visualize.  

Also, it might not necessarily be a trend; especially because months are sort of categorical. Maybe this would be a good use of a Mann-Kendall test?  

```{r}
p <- ggplot(chl_seas) +
  geom_point(aes(x = year, y = median_peak_month)) +
  geom_hline(yintercept = median(chl_seas$median_peak_month, na.rm = TRUE),
             col = "gray40",
             linetype = "dashed") +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("chl peak months by year at ", stn),
       subtitle = "dashed line is overall median",
       y = "peak month")

p
```

I mean..... that seems like it's decreasing.    

```{r}
timing_mk <- EnvStats::kendallTrendTest(median_peak_month ~ year, data = chl_seas)
timing_mk$estimate
timing_mk$p.value

timing_mk2 <- with(chl_seas, Kendall::Kendall(x = year, y = median_peak_month))
timing_mk2
# doesn't give a slope

mkslopes <- timing_mk$estimate 
p +
  geom_abline(slope = mkslopes["slope"], intercept = mkslopes["intercept"]) +
  labs(subtitle = paste0("black line is Kendall trend; p = ", round(timing_mk$p.value, 3)))
```

Not statistically significant. Pretty steep slope though.  

### normalized amplitude by year  

```{r}
ggplot(chl_seas) +
  geom_point(aes(x = year, y = an_normalized_amplitude)) +
  labs(title = paste0("amplitude at ", stn, " through the years"), 
       y = "normalized amplitude")
```

A few years have pretty big amplitudes. Is there a trend?  

```{r}
ampl_mk <- EnvStats::kendallTrendTest(an_normalized_amplitude ~ year, data = chl_seas)
ampl_mk$estimate
ampl_mk$p.value
```

Not significant. Pretty steep slope though.  





## delblnut chl  

```{r}
stn = "delblnut"

chl_dat <- nut |> 
  filter(station == stn) |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)),
         dec_date = lubridate::decimal_date(date),
         log_chla = log10(chla_n))

chl_seas <- chl_ann |> 
  filter(station == stn)
```

First look at a time series plot.  

```{r}
ggplot(chl_dat, aes(x = dec_date, y = chla_n)) +
  geom_point() +
  geom_line() +
  labs(title = paste0("time series of chl at ", stn))
```


```{r}
ggplot(chl_dat, aes(x = dec_date, y = log_chla)) +
  geom_point() +
  geom_line() +
  labs(title = paste0("time series of log10-chl at ", stn))
```


### interaction term plus good graphs  

```{r}
m3 <- gam(log_chla ~ s(year) + s(month) + ti(month, year),
          data = chl_dat)
summary(m3)
appraise(m3)

draw(m3) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(y = "year-month")
```

Significant month x year interaction.  OF course I haven't accounted for autocorrelation yet, so be cautious.  


#### first vs. last year seasonal cycles  

```{r}
newdat <- data.frame(year = c(rep(min(chl_dat$year), length(unique(chl_dat$month))),
                              rep(max(chl_dat$year), length(unique(chl_dat$month)))),
                     month = c(sort(unique(chl_dat$month)), sort(unique(chl_dat$month)))
) |> 
  mutate(date = lubridate::ymd(paste(year, month, 15)))
preds <- predict.gam(m3, newdata = newdat, se.fit = TRUE)
newdat$preds = preds$fit
newdat$se = preds$se.fit

ggplot(newdat) +
  geom_ribbon(aes(x = month, ymin = preds - 2*se, 
                  ymax = preds + 2*se,
                  fill = as.factor(year)),
              alpha = 0.1) +
  geom_line(aes(x = month, y = preds, col = as.factor(year)),
            linewidth = 1) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("seasonality in first and last years at ", stn),
       y = "predicted log(chl)",
       fill = "Year",
       color = "Year")
```

Looks like it's different between the two years.    


```{r}
newdat2 <- newdat |> 
  select(-date, -se) |> 
  mutate(year = case_when(year == max(year) ~ "end",
                          year == min(year) ~ "start")) |> 
  pivot_wider(names_from = year,
              values_from = preds) |> 
  mutate(change = end - start)

ggplot(newdat2, aes(x = month, y = change)) +
  geom_point() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("change between first and last years at ", stn, " by month"))
```

### peak through time  

Visualize.  
 

```{r}
p <- ggplot(chl_seas) +
  geom_point(aes(x = year, y = median_peak_month)) +
  geom_hline(yintercept = median(chl_seas$median_peak_month, na.rm = TRUE),
             col = "gray40",
             linetype = "dashed") +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  labs(title = paste0("chl peak months by year at ", stn),
       subtitle = "dashed line is overall median",
       y = "peak month")

p
```

Eh, maybe there's a trend, but it's not strong.    

```{r}
timing_mk <- EnvStats::kendallTrendTest(median_peak_month ~ year, data = chl_seas)
timing_mk$estimate
timing_mk$p.value

timing_mk2 <- with(chl_seas, Kendall::Kendall(x = year, y = median_peak_month))
timing_mk2
# doesn't give a slope

mkslopes <- timing_mk$estimate 
p +
  geom_abline(slope = mkslopes["slope"], intercept = mkslopes["intercept"]) +
  labs(subtitle = paste0("black line is Kendall trend; p = ", round(timing_mk$p.value, 3)))
```

And it's a flat line.  

### normalized amplitude by year  

```{r}
ggplot(chl_seas) +
  geom_point(aes(x = year, y = an_normalized_amplitude)) +
  labs(title = paste0("amplitude at ", stn, " through the years"), 
       y = "normalized amplitude")
```

Seems like this could be decreasing? 

```{r}
ampl_mk <- EnvStats::kendallTrendTest(an_normalized_amplitude ~ year, data = chl_seas)
ampl_mk$estimate
ampl_mk$p.value
```

Not significant. Also not a very steep slope.    
