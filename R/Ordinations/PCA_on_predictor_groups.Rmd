---
title: "PCA of Predictor Groups"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE, 
                      error = TRUE,
                      fig.width = 7,
                      fig.height = 7)
```

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(tibble)
library(vegan)
library(ggplot2)
library(GGally)
```

# Data import and shaping  

```{r}
load(here::here("Outputs", "calculated_trends", "long-term-trends.RData"))
trends_all <- bind_rows(trends_df, trends_nut) 

# can probably join in primary SWMP station based on reserve code, for later iterations
```

```{r}
metrics_long <- trends_all |> 
  mutate(parameter = str_remove(parameter, "_median"),
         parameter = str_remove(parameter, "_proportion"),
         reserve = substr(station, start = 1, stop = 3),
         station = substr(station, start = 1, stop = 5),
         sig_trend = case_when(sig_trend == "yes" ~ 1,
                               sig_trend == "no" ~ 0,
                               is.na(sig_trend) ~ NA_real_),
         sig_seasonality = case_when(sig_seasonality == "yes" ~ 1,
                                     sig_seasonality == "no" ~ 0,
                                     is.na(sig_seasonality) ~ NA_real_)) |> 
  select(reserve, station, parameter, 
         median = overall_median,
         slope_overall = Slope,
         slope_spring = Spring_estimate,
         slope_summer = Summer_estimate,
         slope_fall = Fall_estimate,
         slope_winter = Winter_estimate)
```


```{r}
  # pivot_wider(id_cols = station,
  #             names_from = parameter,
  #             values_from = Slope_overall:sig_seasonality,
  #             names_glue = "{parameter}_{.value}",
  #             names_vary = "slowest") |> 
  # tibble::column_to_rownames("station")
```


# Group 1: Climate factors  

Water temp, latitude, turbidity? Possibly air temp and PAR if it's reasonable to link the MET data frame. I'm a little worried about associating one value from a MET station to each of 4 values from WQ stations. Would that skew things?  



# Group 2: Physical Setting  

This is mostly a categorical group so it may not be good for PCA.  


# Group 3: Nutrient Loadings  

NH4, NO23, PO4, and DIN:DIP metrics.  

```{r}
params <- c("nh4f", "no23f", "po4f")
nut_group <- metrics_long |> 
  select(-reserve) |> 
  filter(parameter %in% params) |> 
  pivot_wider(names_from = parameter,
              values_from = median:slope_winter,
              names_glue = "{parameter}_{.value}") |> 
  column_to_rownames("station")

# pairs plot showed need to log-transform median concentrations  
nut_group <- nut_group |> 
  mutate(across(c(po4f_median, nh4f_median, no23f_median),
                function(x) log10(x + 0.0001)))

nut_scaled <- nut_group |> 
  mutate(across(everything(),
                function(x) as.vector(scale(x))))

nut_scaled_withNAs <- nut_scaled

nut_scaled[][is.na(nut_scaled[])] <- 0
```

```{r}
ggpairs(nut_scaled_withNAs)
```

Seasonal slopes are really problematic. What is up with those???

This PCA is now on everything, but medians have been log10 transformed. Below will be a PCA on everything BUT the seasonal slopes.

```{r}
nut_pca <- rda(nut_scaled)
```

```{r}
screeplot(nut_pca, type = "lines")
```

Looks like we'd need 4 or 5. 4 explains 63% of the variance and 5 explain 69.7%. I'm not really crazy about that and am tempted to remove seasonal slopes to see what happens. It's also hard to interpret these PCs with so many variables going in, but maybe that will improve if I sort things.   

```{r}
eigs <- summary(eigenvals(nut_pca))
knitr::kable(eigs[, 1:7],
             caption = "Variance explained by PC axes",
             digits = 4)
```

We need 5 axes to even break 70% of variance explained. This isn't useful.  


```{r}
scores_nut <- as.data.frame(scores(nut_pca, choices = 1:5,
                     display = "species",
                     scaling = 0))

knitr::kable(scores_nut,
             caption = "unscaled loadings onto PC axes",
             digits = 4)
```


```{r}
keep <- 1:4


PC1_tops <- scores_nut |> arrange(desc(abs(PC1))) |> select(PC1)
PC2_tops <- scores_nut |> arrange(desc(abs(PC2))) |> select(PC2)
PC3_tops <- scores_nut |> arrange(desc(abs(PC3))) |> select(PC3)
PC4_tops <- scores_nut |> arrange(desc(abs(PC4))) |> select(PC4)


PC_tops <- list(PC1_tops, PC2_tops, PC3_tops, PC4_tops)
```

```{r}
purrr::map(PC_tops, head, 10)
```

PC1 is largely the NH4 axis: overall and all seasonal slopes EXCEPT winter are big loadings on this axis. PO4 moderately loads on this axis for overall, winter, and spring slopes.  

Medians aren't giving us much on this axis.  


PC2 is the NO23 slope axis. Could potentially get away with only using the overall slope for this parameter.  


PC3 we've got PO4 in spring, fall and summer, plus overall PO4 median, and PO4 winter opposing those; NH4 median goes with the bulk of the PO4s.  


PC4 is NH4 and PO4 medians again, in the opposite direction of PO4 spring and summer slopes. So we're separating some overall concentration and seasonality on this one.  


```{r}
biplot(nut_pca,
       display = c("sites",
                   "species"),
       type = c("text",
                "text"))
```


## NUTs but not seasonal slopes  

log(median) and overall slopes only  

```{r}
nut_scaled2 <- nut_scaled |> 
  select(c(ends_with("median"), ends_with("overall")))
```

```{r}
nut_pca2 <- rda(nut_scaled2)

screeplot(nut_pca2, type = "lines")

eigs <- summary(eigenvals(nut_pca2))
knitr::kable(eigs,
             caption = "Variance explained by PC axes",
             digits = 4)
```

3 axes get us to about 75%. Let's see what those are.  

```{r}
scores_nut2 <- as.data.frame(scores(nut_pca2, choices = 1:4,
                     display = "species",
                     scaling = 0))

knitr::kable(scores_nut2,
             caption = "unscaled loadings onto PC axes",
             digits = 4)
```

```{r}
biplot(nut_pca2,
       display = c("sites",
                   "species"),
       type = c("text",
                "text"))
```

```{r}
nut_cor <- cor(nut_scaled2, method = "spearman")
# 'course that has 0s in place of things that couldn't be estimated

corrplot(nut_cor, method = "ellipse")

# look at the data frame that doesn't have 0s
nut_cor2 <- nut_scaled_withNAs |> 
  select(c(ends_with("median"), ends_with("overall"))) |> 
  cor(method = "spearman", use = "pairwise.complete.obs")
corrplot(nut_cor2, method = "ellipse")
```

