---
title: "Trends at Ice Stations"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(lubridate)
library(mgcv)
library(gratia)
library(gt)
library(gtsummary)


source(here::here("helper_files", "definitions.R"))
source(here::here("helper_files", "functions.R"))

load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))
```

## Subset to ice stations  

copied from tables of models that didn't run, in trend_analyses output.

```{r}
ice_wq <- c("grbgbwq", 
            "grblrwq",
            "grborwq",
            "grbsqwq",
            "hudtnwq",
            "hudtswq",
            "lksbawq",
            "lksblwq",
            "lksolwq",
            "owcbrwq",
            "owcdrwq",
            "owcolwq",
            "welhtwq",
            "wellmwq",
            "welsmwq")

ice_nut <- c("grbgbnut", 
             "grblrnut", 
             "grbornut", 
             "grbsqnut", 
             "hudtnnut", 
             "hudtsnut", 
             "lksbanut", 
             "lksblnut", 
             "lksolnut", 
             "narncnut", 
             "narpcnut", 
             "nartbnut", 
             "nartsnut", 
             "nocecnut", 
             "noclcnut", 
             "nocrcnut", 
             "owcbrnut", 
             "owcdrnut", 
             "owcolnut", 
             "owcwmnut", 
             "welhtnut", 
             "welsmnut", 
             "wqbcrnut", 
             "wqbmhnut", 
             "wqbmpnut", 
             "wqbslnut" 
)
```


## resume following trend_analyses.Rmd  

```{r}
dat_wq <- wq |> 
  filter(station %in% ice_wq) |> 
  mutate(do_proportion_below2 = round(doLessThan2_total / doLessThan2_nValid, 4),
         do_proportion_below5 = round(doLessThan5_total / doLessThan5_nValid, 4)) |> 
  select(station, year, month, 
         do_pct_median, do_mgl_median,
         temp_median, spcond_median, 
         sal_median, turb_median,
         do_proportion_below2,
         do_proportion_below5)

# may need to treat DO proportions differently from others - not gaussian, but beta

dat_nut <- nut |> 
  filter(station %in% ice_nut) |> 
  select(station, year, month, 
         chla_n, po4f,
         nh4f, no23f,
         chla_n_cens, po4f_cens,
         nh4f_cens, no23f_cens) |> 
  mutate(DIN_to_DIP = (nh4f + no23f) / po4f,
         DIN_to_DIP_cens = case_when(nh4f_cens + no23f_cens + po4f_cens == 0 ~ 0,
                                     .default = 1))

# DIN_to_DIP may also need to be treated in a non-gaussian way
```

```{r}
# avoiding all proportion/ratio data at this point
wq_grid <- expand.grid(station = unique(dat_wq$station), 
                       param = names(dat_wq[4:9]))
nut_grid <- expand.grid(station = unique(dat_nut$station), 
                       param = names(dat_nut[4:11]))
```

## Attempt to run models  

Can't use my bam function at this point because I hard-coded a cyclical spline with 12 knots. Pull a station or two and see what happens if I let it choose.

```{r}
i=9
stn <- as.character(wq_grid$station[i])
param <- as.character(wq_grid$param[i])

# subset to that stn/param combo
tmp <- subset_df("wq", dat_wq, stn, param)
glimpse(tmp)
```

```{r}
plot(value ~ dec_date, data = tmp, type = "b")
```

```{r}
dat <- tmp
# run bam with an almost-0 rho, using AR.start
  # (in case missing/unevenly spaced data messed up the true ACF)
  # then get the lag-1 acf estimate
  # to use in what will be the "real" bam
  dat_bam <- bam(value ~ dec_date + s(month, bs = "cc"),
                 family = gaussian(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = dat,
                 method = "fREML")
  summary(dat_bam)
  # acf(dat_bam$std.rsd, plot = FALSE)[1]
  
  dat_bam$coefficients
  # 8 knots for monthly smooth when unspecified for this station
  
  dat$preds <- predict.bam(dat_bam, newdata = dat)
  
  
  ggplot(dat) +
    geom_line(aes(x = dec_date, y = preds, col = "predicted")) +
    geom_point(aes(x = dec_date, y = preds, col = "predicted")) +
    geom_point(aes(x = dec_date, y = value, col = "actual")) +
    geom_line(aes(x = dec_date, y = value, col = "actual"), alpha = 0.5)
  
  
  
  
  
  
  rhos <- acf(dat_bam$std.rsd, plot = FALSE)
  use_this_rho <- round(rhos$acf[2], 4)  # 2nd position is lag 1
  rho_threshold <- qnorm((1 + 0.95)/2)/sqrt(rhos$n.used)
  
  if(abs(use_this_rho) > rho_threshold){
    dat_bam <- bam(value ~ dec_date + s(month, bs = "cc"),
                   family = gaussian(),
                   discrete = TRUE,
                   AR.start = ARrestart,
                   rho = use_this_rho,
                   data = dat,
                   method = "fREML")
  }
  
  final_AR <- acf(dat_bam$std.rsd, plot = FALSE)
  final_AR <- round(final_AR$acf[2], 4)  # 2nd position is lag 1
  print(paste("Original autocorrelation lag 1 coefficient was:", round(use_this_rho, 3)))
  print(paste("Threshold to re-run bam was:",
              round(rho_threshold, 3)))
  print(paste("Final autocorrelation lag 1 coefficient is:", 
              final_AR))
```

So 8 knots worked for that station. Do I have a way to pre-calculate that, or do I just let the models go nuts?  

First see how many months have data each year, maybe that's a clue.  

```{r}
tmp |> 
  summarize(.by = year,
            nMonths = sum(!is.na(value)))

tmp |> 
  summarize(.by = month,
            nYears = sum(!is.na(value))) |> 
  arrange(month)
```

3 years have 8 readings; 4 years have only 7. Wonder if it would be better with 7 knots? Or since we have at least more than one with the higher number, if that's okay?

```{r}
dat_bam1 <- bam(value ~ dec_date + s(month, bs = "cc", k = 8),
                 family = gaussian(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = dat,
                 method = "fREML")

dat_bam2 <- bam(value ~ dec_date + s(month, bs = "cc", k = 7),
                 family = gaussian(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = dat,
                 method = "fREML")

# keeping in mind we've ignored autocorrelation
AIC(dat_bam1, dat_bam2, dat_bam)
```

Can find where it put the knots:  

```{r}
dat_bam$smooth[[1]]$xp
dat_bam1$smooth[[1]]$xp
dat_bam2$smooth[[1]]$xp

dat_bam2$smooth[[1]]$bs.dim  # this is what 'k' was - actually 10 for dat_bam
```


```{r}
gnd <- subset_df("wq", wq, "gndbhwq", "do_pct_median")

gnd_bam1 <- bam(value ~ dec_date + s(month, bs = "cc", k = 12),
                 family = gaussian(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = gnd,
                 method = "fREML")

gnd_bam2 <- bam(value ~ dec_date + s(month, bs = "cc"),
                 family = gaussian(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = gnd,
                 method = "fREML")

# how many?
gnd_bam1$smooth[[1]]$bs.dim
gnd_bam2$smooth[[1]]$bs.dim

# where?
gnd_bam1$smooth[[1]]$xp
gnd_bam2$smooth[[1]]$xp

AIC(gnd_bam1, gnd_bam2)

plot(gnd_bam1)
plot(gnd_bam2)

appraise(gnd_bam1)
draw(gnd_bam1, residuals = TRUE)
appraise(gnd_bam2)
draw(gnd_bam2, residuals = TRUE)

preds_df <- predict(gnd_bam1, newdata = gnd, se = TRUE)
gnd$predicted <- preds_df$fit
gnd$pred_se <- preds_df$se.fit

ggplot(gnd, aes(x = dec_date)) +
    geom_ribbon(aes(ymin = predicted - 1.96*pred_se,
                  ymax = predicted + 1.96*pred_se),
              alpha = 0.5) +
    geom_point(aes(y = value, color = "observed"),
             alpha = 0.7) +
    geom_line(aes(y = predicted, color = "predicted"),
            linewidth = 0.7)



```

```{r}
gndnh4 <- subset_df("nut", nut, "gndbhnut", "nh4f")

gnd_bam1 <- bam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                 family = cnorm(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = gndnh4,
                 method = "fREML")

gnd_bam2 <- bam(lognut_mat ~ dec_date + s(month, bs = "cc"),
                 family = cnorm(),
                 discrete = TRUE,
                 AR.start = ARrestart,
                 rho = 0.0001,
                 data = gndnh4,
                 method = "fREML")

# how many?
gnd_bam1$smooth[[1]]$bs.dim
gnd_bam2$smooth[[1]]$bs.dim

# where?
gnd_bam1$smooth[[1]]$xp
gnd_bam2$smooth[[1]]$xp

AIC(gnd_bam1, gnd_bam2)

plot(gnd_bam1)
plot(gnd_bam2)
```

