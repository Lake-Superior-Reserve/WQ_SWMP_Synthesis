---
title: "Trend visualizations"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
```

```{r}
region_dictionary <- read.csv(here::here("helper_files",
                                         "region_dictionary.csv"))
```


```{r}
load(here::here("Outputs", 
                "calculated_trends",
                "long-term-trends.RData"))

trends_all <- bind_rows(trends_df, trends_met, trends_nut) |> 
  mutate(reserve = str_sub(station, start = 1, end = 3),
         type = case_when(str_ends(station, "wq") ~ "wq",
                          str_ends(station, "met") ~ "met",
                          str_ends(station, "nut") ~ "nut",
                          .default = "something's wrong")) |> 
  filter(ts_length >= 9) |>  # get rid of any where the time series wasn't as long as the station
  left_join(region_dictionary, by = c("reserve" = "Reserve"))


trends_seasonal <- trends_all |> 
  select(station, parameter, reserve, type, Region,
         Fall_estimate:Summer_p.value) |> 
  pivot_longer(Fall_estimate:Summer_p.value,
               names_to = c("Season", "parm"),
               names_sep = "_",
               values_to = "value") |> 
  pivot_wider(names_from = parm,
              values_from = value)
```

```{r}
rm(trends_df, trends_met, trends_nut, region_dictionary)
```


# Long-Term Overall  

## WQ  


```{r}
trends_all |>
  filter(type == "wq") |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in [parameter's measurement units] / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```

```{r}
ggplot(filter(trends_all, type == "wq")) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 30,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in [parameter's measurement units] / year")
```

```{r}
ggplot(filter(trends_all, type == "wq")) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  geom_smooth(method = "loess", se = FALSE,
              aes(x = ts_length,
                  y = Slope,
                  col = parameter),
              alpha = 0.6) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in [parameter's measurement units] / year")
```

```{r, fig.width = 6, fig.height = 3.5}
seas_wq <- trends_all |>
  filter(type == "wq") |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_wq) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```


## MET  


```{r}
trends_all |>
  filter(type == "met") |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in [parameter's measurement units] / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```

```{r}
ggplot(filter(trends_all, type == "met")) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 20,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in [parameter's measurement units] / year")
```



```{r}
ggplot(filter(trends_all, type == "met")) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  geom_smooth(method = "loess", se = FALSE,
              aes(x = ts_length,
                  y = Slope,
                  col = parameter),
              alpha = 0.6) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in [parameter's measurement units] / year")
```


```{r, fig.width = 6, fig.height = 3.5}
seas_met <- trends_all |>
  filter(type == "met") |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_met) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```


## NUT  

```{r}
trends_all |>
  filter(type == "nut") |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in (log-10 [nutrient units]) / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```

```{r}
ggplot(filter(trends_all, type == "nut")) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 30,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in (log-10 [nutrient units]) / year")
```

```{r}
ggplot(filter(trends_all, type == "nut")) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  geom_smooth(method = "loess", se = FALSE,
              aes(x = ts_length,
                  y = Slope,
                  col = parameter),
              alpha = 0.6) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in log10[parameter's measurement units] / year")
```


```{r, fig.width = 6, fig.height = 3.5}
seas_nut <- trends_all |> 
  filter(type == "nut") |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_nut) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```

# Long-term by season  

```{r}
parms <- unique(trends_all$parameter)
for(i in seq_along(parms)){
  
  tmp <- filter(trends_all, parameter == parms[i])
  
  ggplot(tmp) +
    geom_histogram(aes(x = Slope)) +
    facet_wrap(~sea)
}
```




# Long-term by region  



# Long-term by season x region


