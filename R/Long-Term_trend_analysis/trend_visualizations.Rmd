---
title: "Trend visualizations"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```


# Read in tables of trend results  

```{r}
load(here::here("Outputs", 
                "calculated_trends",
                "long-term-trends.RData"))
```

# Graphs  

## WQ  


```{r}
trends_df |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in [parameter's measurement units] / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```



```{r}
ggplot(trends_df) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 30,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in [parameter's measurement units] / year")
```

```{r, fig.width = 6, fig.height = 3.5}
seas_df <- trends_df |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_df) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```


```{r}
ggplot(trends_df) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in [parameter's measurement units] / year")
```



## MET  


```{r}
trends_met |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in [parameter's measurement units] / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```



```{r}
ggplot(trends_met) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 20,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in [parameter's measurement units] / year")
```



```{r}
ggplot(trends_met) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in [parameter's measurement units] / year")
```


```{r, fig.width = 6, fig.height = 3.5}
seas_df <- trends_met |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_df) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```



## NUT  

```{r}
trends_nut |> 
  arrange(parameter, Slope, station) |> 
  mutate(stparm = paste0(station, parameter)) |> 
  ggplot(aes(x = forcats::fct_inorder(stparm), y = Slope)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,
                      col = sig_trend)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~parameter, scales = "free") +
  labs(title = "Slopes for all stations",
       subtitle = "slopes are in (log-10 [nutrient units]) / year",
       x = "Station",
       col = "Significant slope?") +
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.position = "bottom", 
        legend.justification = "left",
        legend.direction = "horizontal")
```

```{r}
ggplot(trends_nut) +
  geom_histogram(aes(x = Slope,
                     fill = parameter),
                 bins = 30,
                 col = "gray20",
                 alpha = 0.8) +
  facet_wrap(~parameter, scales = "free") +
  geom_vline(xintercept = 0,
             linewidth = 1) +
  theme(legend.position = "none") +
  labs(title = "Histograms of slopes for each parameter",
       subtitle = "slopes are in (log-10 [nutrient units]) / year")
```



```{r}
ggplot(trends_nut) +
  geom_point(aes(x = ts_length,
                 y = Slope,
                 col = parameter),
             alpha = 0.7) +
  facet_wrap(~parameter, scales = "free") +
  geom_hline(yintercept = 0,
             linewidth = 0.7) +
  theme(legend.position = "none") +
  labs(title = "Slopes as a function of time series length for each parameter",
       x = "Time Series length (years)",
       subtitle = "slopes are in log10[parameter's measurement units] / year")
```


```{r, fig.width = 6, fig.height = 3.5}
seas_nut <- trends_nut |> 
  summarize(.by = c(parameter, sig_seasonality),
            n()) |> 
  pivot_wider(names_from = sig_seasonality,
              values_from = `n()`) |> 
  mutate(no = -1*no)

ggplot(seas_nut) +
  geom_segment( aes(x=parameter, xend=parameter, y=no, yend=yes)) +
  geom_point( aes(x=parameter, y=no, color="seasonal"), size=3 ) +
  geom_point( aes(x=parameter, y=yes, color="not seasonal"), size=3 ) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  coord_flip()+
  theme(
    legend.position = "none",
  ) +
  xlab("") +
  ylab("# of stations displaying seasonality")
```

```{r}

```

