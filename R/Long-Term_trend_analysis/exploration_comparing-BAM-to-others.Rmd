---
title: "Long-Term Trend Analyses - BAM testing and comparisons"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

It appears that `mgcv::bam()` will work well for our needs - dealing with seasonality, censoring, missing data, and autocorrelation.  

In this document, I will compare `bam` output to a variety of simpler outputs, in order to convince all of us that it is in fact working how we expect it to.  

This file is based on `exploration_building-up-to-GAM.Rmd` but I am working to abstract into functions, rather than repeating code for every station. I will also produce more streamlined graphics and tables.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      fig.width = 6,
                      fig.height = 4)
```

```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(patchwork)
library(broom)
library(mgcv)
library(NADA2)
library(gt)
library(gtsummary)  # note this didn't work until I'd also installed broom.mixed

```


Here we will use decimal date, so **trends can be interpreted as change per year.** Nutrient concentrations will be **log-transformed** which will affect interpretation. In the original GAM exploration file, I simply used `log()`, which was a natural-log transformation. Moving forward I will use a log-10 (`log10()`) transformation, for better interpretability.        

# Data  

Will work with a few parameter/station combos; all from aggregated monthly files:  

**Nutrients**:  

-  `cbmipnut` PO4 - seems to have a negative trend  
-  `cbvginut` NO23 - MDL increases; looks like the nutrient itself probably doesn't, and I want to see what the GAM gives us.  
-  `gndhsnut` NH4F - seems to be decreasing, even with decreasing MDL.  


**Water Quality**:  

-  `gndpcwq` spcond_median seems to be decreasing (?)  
-  `gndbcwq` - cdepth_median seems to be increasing  
-  `niwolwq` - do-pct - doesn't seem to be changing (visually anyway)  


```{r}
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
source(here::here("helper_files", "functions.R"))
```

```{r}
# nut data sets  
cbmip <- subset_df("nut", nut, "cbmipnut", "po4f")
cbvgi <- subset_df("nut", nut, "cbvginut", "no23f")
gndhs <- subset_df("nut", nut, "gndhsnut", "nh4f")

# wq data sets
gndpc <- subset_df("wq", wq, "gndpcwq", "spcond_median")
gndbc <- subset_df("wq", wq, "gndbcwq", "cdepth_median")
niwol <- subset_df("wq", wq, "niwolwq", "do_pct_median")
```

# CBMIPNUT {.tabset}  

PO4 - seems to (visually) have a negative trend. No censoring.

```{r}
dat <- cbmip
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

1.  Run model with a rho of almost-0; not accounting for autocorrelation. Use `AR.start` to account for missing data points.  
2.  Determine whether there is significant autocorrelation in the residuals.  
3.  If so, re-run model, setting `rho` to what was found in step 2.  

```{r}
dat_bam <- run_bam_nut(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```


```{r}
# cis in the plot:
# qnorm((1 + ci)/2)/sqrt(x$n.used)
# from https://stats.stackexchange.com/questions/211628/how-is-the-confidence-interval-calculated-for-the-acf-function

# would want to adjust rho when it is outside +/- the following:
# qnorm((1 + 0.95)/2)/sqrt(acf.out$n.used)

# this stackexchange post has some info from Hyndman & Athanasopoulos about the theory/math:
# https://stats.stackexchange.com/questions/49571/understanding-the-blue-dotted-lines-in-an-acf-from-r
```


## output thoughts  


I'm still the tiniest bit concerned that the `acf` is still inaccurate, because the lag 1 value matched between models where I used `AR.start` and where I didn't. Maybe trying this on some other datasets will reassure me.  


Even with `bam` using `discrete = TRUE` and the `AR.start` stuff, we're getting the same AR1 coefficient as in the other `gam` models. This makes me worry a bit that the missing data isn't being handled the way I think it should be. Only `gamm` comes out different. Hm, it's the `Phi1` that comes out different in `gamm`; `acf(resid(dat_gam_ar$lme, type = "response"))[1]` matches everything else (0.281).    

What results do we want to pull out of our final model?  `gtsummary::tidy_gam()` seems to pull out everything I want! At least for rate of change and info about seasonality.  

-  slope and std error for dec_date - change/year
-  p-value for dec_date  
-  edf, ref.df, F, p for seasonal smooth  
    -  I'm imagining some sort of "seasonality was significant for X of the Y stations" for each parameter summary - e.g., DO is almost always seasonal; turbidity maybe wouldn't be; nutrients up in the air....  
    -  maybe a dumbbell plot, where each line is a parameter, and one side of the graph is the number of stations with significant seasonality, and the other side is without significant seasonality. Like this population pyramid, but with lollipops instead of bars: https://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html#Population%20Pyramid  or this lollipop plot, but centered on 0: https://r-graph-gallery.com/303-lollipop-plot-with-2-values.html  
-  R^2 adj; deviance explained  
-  what is the number in parentheses at the top of the summary: Family: cnorm(0.703) - maybe that number? Must be `theta` - from the help file: "theta -
log standard deviation parameter. If supplied and positive then taken as a fixed value of standard deviation (not its log). If supplied and negative taken as negative of initial value for standard deviation (not its log)."
-  rho?    

Should we only supply rho if it's outside the blue lines in the 'test' model? If so, how do we figure that out? In `?plot.acf`, it looks like these are a 95% confidence interval, but the help file doesn't say how the CI is calculated. Just says: "The confidence interval plotted in plot.acf is based on an uncorrelated series and should be treated with appropriate caution. Using ci.type = "ma" may be less potentially misleading."   

Can set `plot = FALSE` in the `acf()` call if we don't want to see it  


## gamm (no censoring)  

Rho from bam was 0.28. Here, it's 0.31. 

Slope estimate from bam was -0.0353, SE 0.0049  
From gamm:  -0.03596, SE 0.0051  

Virtually indistinguishable. Seasonal terms are extremely similar too.  

```{r}
dat_gam_ar <- gamm(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                     data = dat,
                     correlation = corAR1(form = ~ month|year),
                     method = "REML")
summary(dat_gam_ar$gam)
summary(dat_gam_ar$lme)
summary(dat_gam_ar$lme$modelStruct$corStruct)
acf(resid(dat_gam_ar$lme, type = "normalized"))[1] 
acf(resid(dat_gam_ar$lme, type = "response"))[1]
tbl_regression(dat_gam_ar)
```




## Simple Regression  

Note this autocorrelation could be misleading, because it does not account for the fact that there are missing time points.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression using the `NADA2` package doesn't work with this station because there are no censored values.  



## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  

Yep, slope similar to everything else: -0.036. St. error 0.005. High residual autocorrelation, 0.493.    

```{r}
dat_gam_cens <- gam(lognut_mat ~ dec_date,
                    family = cnorm(),
                    data = dat,
                    method = "REML")
summary(dat_gam_cens)
acf(residuals(dat_gam_cens), plot = FALSE)[1]
```



## GAM w/seasonality only  

This slope will be most comparable to the simple regression model.  

Seasonal term is highly significant. Linear trend slope looks the same as before, though standard error is a bit smaller.  R^2 went up from about 0.2 (linear model) to about 0.5.  

Even after accounting for seasonality, there's autocorrelation in the residuals; much less though (0.28).  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

```{r}
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```

Similar slope to all that came before with this station, -0.036. SE 0.004. Again, accounting for seasonality has reduced the residual autocorrelation to 0.28 (still high, and bam reduces it).    


***  

# CBVGINUT {.tabset}  

NO23 - MDL increases; looks like the nutrient itself probably doesn't, so accounting for censoring is important.  


```{r}
dat <- cbvgi
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

```{r}
dat_bam <- run_bam_nut(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```


## Simple Regression  

Simple regression does (**wrongly**) point to a significant increasing trend.  

Note this autocorrelation could be misleading, because it does not account for the fact that there are missing time points.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression correctly avoids identifying a positive (or any) trend in the nutrient.  

```{r}
dat_cr <- with(dat, cencorreg(lognut, cens, dec_date,
                              verbose = 0,
                              LOG = FALSE))
summary(dat_cr)
```


## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  


## GAM w/seasonality only  

This slope will be most comparable to the simple regression model, and will be an inaccurate slope due to the effects of censoring. Seasonal term is significant. R^2 went up from 0.03 to 0.23. Even after accounting for seasonality, there's autocorrelation in the residuals.  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

Got a similar-ish slope to the censored regression! -0.0062 for the GAM; -0.0037 for cenreg. Neither statistically significant. Can see from the GAM that seasonality is significant. Negative R^2 though?  

```{r}
# need a matrix with nutrient and censoring values
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```



***  

# GNDHSNUT {.tabset}  

NH4F - seems to be decreasing, even with decreasing MDL.  


```{r}
dat <- gndhs
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

Identifies significant decreasing trend of -0.036. R^2 0.21. Seasonal term not significant. Autocorrelation of residuals was not significant, so model was not re-run.  

```{r}
dat_bam <- run_bam_nut(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```


## Simple Regression  

Simple regression identifies a significant decreasing trend, slope -0.041. R^2 0.20.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression identifies a significant negative trend, slope -0.036, which matches that of the bam.   

```{r}
dat_cr <- with(dat, cencorreg(lognut, cens, dec_date,
                              verbose = 0,
                              LOG = FALSE))
summary(dat_cr)
```


## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  


## GAM w/seasonality only  

This slope matches that of the simple regression model, -0.041. Seasonality term not significant. R^2 0.21.  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

Same slope as both other models that incorporated censoring: -0.037. Seasonal term again non-significant. R^2 again 0.21.    

```{r}
# need a matrix with nutrient and censoring values
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```


***  


# GNDPCWQ {.tabset}  

spcond_median seems to be decreasing (?)   

No need for censoring + autocorrelation together, so could use either `bam` or `gamm`.  

```{r}
dat <- gndpc
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 3, fig.width = 6}
plot_wq(dat)
```

## bam  

Significant decrease, slope -0.45. SE for slope is 0.132.  

This is a larger SE than what I get from `gamm` - perhaps because `bam` allows discrete chunks of data and `gamm` doesn't. Also, I only set `gamm` to allow AR1 correlation by month, which will be within a year (did this to try to account for missing months) - wouldn't necessarily be smooth between December and January.  

```{r}
dat_bam <- run_bam_wq(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```


## gamm: AR + seasonality  

I'm less comfortable with `gamm` than `bam` because it's not as clear what's the appropriate way to set up the autocorrelation structure.  

From `?corAR1`, `form` argument: a one sided formula of the form `~ t`, or `~ t | g`, specifying a time covariate `t` and, optionally, a grouping factor `g`. A covariate for this correlation structure must be integer valued. When a grouping factor is present in form, the correlation structure is assumed to apply only to observations within the same grouping level; observations with different grouping levels are assumed to be uncorrelated.  

Going with `~ month | year`, because month is the time step. This seems like it's probably the most appropriate of the `gamm` options.   

Slope output is -0.4355, SE 0.1346. Similar SE to `bam`, slightly different slope, probably not worryingly so.  

```{r}
dat_gam_ar <- gamm(value ~ dec_date + s(month, bs = "cc", k = 12),
                     data = dat,
                     correlation = corAR1(form = ~ month|year),
                     method = "REML")
summary(dat_gam_ar$gam)
summary(dat_gam_ar$lme)

# original autocorrelation (not accounting for it in model)
acf(resid(dat_gam_ar$lme, type = "response"))[1]

# the normalized ones are what we want to be low
acf(resid(dat_gam_ar$lme, type = "normalized"))[1] 
```


## Simple Regression  

Slope -0.4787, SE 0.1093, R^2 0.093; high autocorrelation in residuals (and can see seasonality when plotted).    

```{r}
dat_lm <- lm(value ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Simple GAM  

Slope -0.4787 (same as simple regression), SE 0.1093 (same as regression), R^2 0.088; high autocorrelation of residuals.  

```{r}
dat_gam_simple <- gam(value ~ dec_date,
                data = dat,
                method = "REML")
summary(dat_gam_simple)
acf(residuals(dat_gam_simple), plot = FALSE)[1]
```
 


## GAM w/seasonality  

Seasonal term significant. Slope -0.45, st. error 0.081. R^2 0.50.  

From linear model, slope was -0.479, st. error 0.109, R^2 0.093. Seasonal GAM improved R^2 and standard error; didn't really change slope.  

Substantial autocorrelation.   

```{r}
dat_gam_seas <- gam(value ~ dec_date + s(month, bs = "cc", k = 12),
                data = dat,
                method = "REML")
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
# pacf(residuals(gndpc_gam_seas))
```




# GNDBCWQ {.tabset}  

cdepth_median seems to be increasing  


```{r}
dat <- gndbc
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 3, fig.width = 6}
plot_wq(dat)
```

## bam  

Significant increase, slope 0.032, SE 0.0025, R^2 0.761, final AR 0.022  

```{r}
dat_bam <- run_bam_wq(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```

```{r, eval = FALSE}
# response residuals (uncorrected for autocorrelation)
acf(residuals(dat_bam))[1]

# standardized residuals (corrected for autocorrelation)
acf(dat_bam$std.rsd)[1]
```


## gamm: AR + seasonality  

Significant increase, slope 0.032, SE 0.0028, R^2 0.759, AR -0.07 (from original 0.218)  

Very, very similar to `bam` output.  

```{r}
dat_gam_ar <- gamm(value ~ dec_date + s(month, bs = "cc", k = 12),
                     data = dat,
                     correlation = corAR1(form = ~ month|year),
                     method = "REML")
summary(dat_gam_ar$gam)
summary(dat_gam_ar$lme)

# original autocorrelation (not accounting for it in model)
acf(resid(dat_gam_ar$lme, type = "response"))[1]

# the normalized ones are what we want to be low
acf(resid(dat_gam_ar$lme, type = "normalized"))[1] 
```


## Simple Regression  

Slope 0.033, SE 0.003, R^2 0.50; AR 0.51  (didn't account for seasonality or AR in model)     

```{r}
dat_lm <- lm(value ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Simple GAM  

All same as simple regression  

```{r}
dat_gam_simple <- gam(value ~ dec_date,
                data = dat,
                method = "REML")
summary(dat_gam_simple)
acf(residuals(dat_gam_simple), plot = FALSE)[1]
```
 


## GAM w/seasonality  

Slope 0.032, SE 0.002, R^2 0.76, significant seasonal term, AR of residuals 0.195 - pretty similar to bam or gamm before adjusting for AR    

```{r}
dat_gam_seas <- gam(value ~ dec_date + s(month, bs = "cc", k = 12),
                data = dat,
                method = "REML")
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
# pacf(residuals(gndpc_gam_seas))
```



***  



# NIWOLWQ {.tabset}  

do-pct - doesn't seem to be changing (visually)  

```{r}
dat <- niwol
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 3, fig.width = 6}
plot_wq(dat)
```

## bam  

Significant decrease (p = 0.016), slope -0.128, SE 0.053, R^2 0.898, Seasonal term significant, final AR -0.003 (from 0.272)    

```{r}
dat_bam <- run_bam_wq(dat)
```

```{r}
summary(dat_bam)
print_bam_table(dat_bam) |> 
  tab_header(title = plt_titles)
```


## gamm: AR + seasonality  

Significant decrease (p = 0.012), slope -0.137, SE 0.054, R^2 0.898, Seasonal term significant, AR -0.019 (from original 0.287)  

Very, very similar to `bam` output.  

```{r}
dat_gam_ar <- gamm(value ~ dec_date + s(month, bs = "cc", k = 12),
                     data = dat,
                     correlation = corAR1(form = ~ month|year),
                     method = "REML")
summary(dat_gam_ar$gam)
summary(dat_gam_ar$lme)

# original autocorrelation (not accounting for it in model)
acf(resid(dat_gam_ar$lme, type = "response"))[1]

# the normalized ones are what we want to be low
acf(resid(dat_gam_ar$lme, type = "normalized"))[1] 
```


## Simple Regression  

Slope not significant (p = 0.215); slope -0.157, SE 0.126, R^2 0.006, VERY high AR 0.805       

```{r}
dat_lm <- lm(value ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Simple GAM  

All same as simple regression  

```{r}
dat_gam_simple <- gam(value ~ dec_date,
                data = dat,
                method = "REML")
summary(dat_gam_simple)
acf(residuals(dat_gam_simple), plot = FALSE)[1]
```
 


## GAM w/seasonality  

Change significant (p = 0.002), slope -0.126, SE 0.04, R^2 0.899, Seasonal term significant, AR 0.272    

```{r}
dat_gam_seas <- gam(value ~ dec_date + s(month, bs = "cc", k = 12),
                data = dat,
                method = "REML")
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
# pacf(residuals(gndpc_gam_seas))
```


# Takeaways  

-  Residuals from the most basic models (response ~ time) have very cyclic patterns for most parameters - indicating seasonality.  
-  Putting a seasonal term in the model, using any of the `gam` functions, accounts for a lot of residual correlation, but not all of it.  
-  Accounting for autocorrelation through either `bam` or `gamm` takes care of the rest.  
-  Accounting for seasonality GREATLY improves R^2 values.  
-  Accounting for seasonality and autocorrelation typically widen confidence intervals (though in the case of NIWOLWQ, accounting for them caused a significant trend to appear that was not apparent in simple regressions).  
-  In any case, accounting for seasonality and autocorrelation do seem to be the most appropriate methods, and give similar slopes to the simpler methods.  
-  Accounting for censoring is VERY important when it is present, as ignoring it can lead to false trend detection (see CBVGINUT). When it is not present, results are the same as from other methods.    
-  Outputs from `bam` and `gamm` are very similar.  
-  `gamm` is nice because it takes care of `phi`/`rho` for you.  
-  BUT `bam` is more *universally* useful because it can be used with censored data.  
-  It may be a good idea to use the same function for all parameters, even those without censoring, for consistency in code and pulling out results. `gamm` provides indistinguishable results from `bam`, but capturing outputs involves very different code and syntax, and I'm worried things could go wrong if we switch between them.  