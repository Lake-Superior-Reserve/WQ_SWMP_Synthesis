---
title: "Long-Term Trend Analyses - BAM testing and comparisons"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

It appears that `mgcv::bam()` will work well for our needs - dealing with seasonality, censoring, missing data, and autocorrelation.  

In this document, I will compare `bam` output to a variety of simpler outputs, in order to convince all of us that it is in fact working how we expect it to.  

This file is based on `exploration_building-up-to-GAM.Rmd` but I am working to abstract into functions, rather than repeating code for every station. I will also produce more streamlined graphics and tables.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      fig.width = 6,
                      fig.height = 4)
```

```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(patchwork)
library(broom)
library(mgcv)
library(NADA2)
library(gt)
library(gtsummary)  # note this didn't work until I'd also installed broom.mixed

```


Here we will use decimal date, so **trends can be interpreted as change per year.** Nutrient concentrations will be **log-transformed** which will affect interpretation. In the original GAM exploration file, I simply used `log()`, which was a natural-log transformation. Moving forward I will use a log-10 (`log10()`) transformation, for better interpretability.        

# Data  

Will work with a few parameter/station combos; all from aggregated monthly files:  

**Nutrients**:  

-  `cbmipnut` PO4 - seems to have a negative trend  
-  `cbvginut` NO23 - MDL increases; looks like the nutrient itself probably doesn't, and I want to see what the GAM gives us.  
-  `gndhsnut` NH4F - seems to be decreasing, even with decreasing MDL.  


**Water Quality**:  

-  `gndpcwq` spcond_median seems to be decreasing (?)  
-  `gndbcwq` - cdepth_median seems to be increasing  
-  `niwolwq` - do-pct - doesn't seem to be changing (visually anyway)  


```{r}
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
source(here::here("helper_files", "functions.R"))
```

```{r}
# nut data sets  
cbmip <- subset_df("nut", nut, "cbmipnut", "po4f")
cbvgi <- subset_df("nut", nut, "cbvginut", "no23f")
gndhs <- subset_df("nut", nut, "gndhsnut", "nh4f")

# wq data sets
gndpc <- subset_df("wq", wq, "gndpcwq", "spcond_median")
gndbc <- subset_df("wq", wq, "gndbcwq", "cdepth_median")
niwol <- subset_df("wq", wq, "niwolwq", "do_pct_median")
```

# CBMIPNUT {.tabset}  

PO4 - seems to (visually) have a negative trend. No censoring.

```{r}
dat <- cbmip
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

1.  Run model with a rho of almost-0; not accounting for autocorrelation. Use `AR.start` to account for missing data points.  
2.  Determine whether there is significant autocorrelation in the residuals.  
3.  If so, re-run model, setting `rho` to what was found in step 2.  

```{r, results = "asis"}
run_bam_nut()
```

```{r}
print_bam_table()
```

```{r}
# cis in the plot:
# qnorm((1 + ci)/2)/sqrt(x$n.used)
# from https://stats.stackexchange.com/questions/211628/how-is-the-confidence-interval-calculated-for-the-acf-function

# would want to adjust rho when it is outside +/- the following:
# qnorm((1 + 0.95)/2)/sqrt(acf.out$n.used)

# this stackexchange post has some info from Hyndman & Athanasopoulos about the theory/math:
# https://stats.stackexchange.com/questions/49571/understanding-the-blue-dotted-lines-in-an-acf-from-r
```


## output thoughts  


I'm still the tiniest bit concerned that the `acf` is still inaccurate, because the lag 1 value matched between models where I used `AR.start` and where I didn't. Maybe trying this on some other datasets will reassure me.  


What results do we want to pull out of our final model?  `gtsummary::tidy_gam()` seems to pull out everything I want! At least for rate of change and info about seasonality.  

-  slope and std error for dec_date - change/year
-  p-value for dec_date  
-  edf, ref.df, F, p for seasonal smooth  
    -  I'm imagining some sort of "seasonality was significant for X of the Y stations" for each parameter summary - e.g., DO is almost always seasonal; turbidity maybe wouldn't be; nutrients up in the air....  
    -  maybe a dumbbell plot, where each line is a parameter, and one side of the graph is the number of stations with significant seasonality, and the other side is without significant seasonality. Like this population pyramid, but with lollipops instead of bars: https://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html#Population%20Pyramid  or this lollipop plot, but centered on 0: https://r-graph-gallery.com/303-lollipop-plot-with-2-values.html  
-  R^2 adj; deviance explained  
-  what is the number in parentheses at the top of the summary: Family: cnorm(0.703) - maybe that number? Must be `theta` - from the help file: "theta -
log standard deviation parameter. If supplied and positive then taken as a fixed value of standard deviation (not its log). If supplied and negative taken as negative of initial value for standard deviation (not its log)."
-  rho?    

Should we only supply rho if it's outside the blue lines in the 'test' model? If so, how do we figure that out? In `?plot.acf`, it looks like these are a 95% confidence interval, but the help file doesn't say how the CI is calculated. Just says: "The confidence interval plotted in plot.acf is based on an uncorrelated series and should be treated with appropriate caution. Using ci.type = "ma" may be less potentially misleading."   

Can set `plot = FALSE` in the `acf()` call if we don't want to see it  


## Simple Regression  

Note this autocorrelation could be misleading, because it does not account for the fact that there are missing time points.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression using the `NADA2` package doesn't work with this station because there are no censored values.  



## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  



## GAM w/seasonality only  

This slope will be most comparable to the simple regression model.  

Seasonal term is highly significant. Linear trend slope looks the same as before, though standard error is a bit smaller.  R^2 went up from about 0.2 (linear model) to about 0.5.  

Even after accounting for seasonality, there's autocorrelation in the residuals; much less though.  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

```{r}
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```

Similar slope to all that came before with this station. Again, accounting for seasonality has reduced the residual autocorrelation.  


***  

# CBVGINUT {.tabset}  

NO23 - MDL increases; looks like the nutrient itself probably doesn't, so accounting for censoring is important.  


```{r}
dat <- cbvgi
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

```{r, results = "asis"}
run_bam_nut()
```


```{r}
print_bam_table()
```


## Simple Regression  

Simple regression does (**wrongly**) point to a significant increasing trend.  

Note this autocorrelation could be misleading, because it does not account for the fact that there are missing time points.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression correctly avoids identifying a positive (or any) trend in the nutrient.  

```{r}
dat_cr <- with(dat, cencorreg(lognut, cens, dec_date,
                              verbose = 0,
                              LOG = FALSE))
summary(dat_cr)
```


## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  


## GAM w/seasonality only  

This slope will be most comparable to the simple regression model, and will be an inaccurate slope due to the effects of censoring. Seasonal term is significant. R^2 went up from 0.03 to 0.23. Even after accounting for seasonality, there's autocorrelation in the residuals.  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

Got a similar-ish slope to the censored regression! -0.0062 for the GAM; -0.0037 for cenreg. Neither statistically significant. Can see from the GAM that seasonality is significant. Negative R^2 though?  

```{r}
# need a matrix with nutrient and censoring values
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```



***  

# GNDHSNUT {.tabset}  

NH4F - seems to be decreasing, even with decreasing MDL.  


```{r}
dat <- gndhs
plt_titles <- paste(unique(dat$station), unique(dat$focal_param))
```

```{r, fig.height = 6, fig.width = 6}
plot_nuts(dat)
```


## bam  

Identifies significant decreasing trend of -0.036. R^2 0.21. Seasonal term not significant. Autocorrelation of residuals was not significant, so model was not re-run.  

```{r}
run_bam_nut()
```

```{r}
print_bam_table()
```

## Simple Regression  

Simple regression identifies a significant decreasing trend, slope -0.041. R^2 0.20.  

```{r}
dat_lm <- lm(lognut ~ dec_date, data = dat)
summary(dat_lm)
acf(residuals(dat_lm), plot = FALSE)[1]
```


## Censored Regression  

Censored regression identifies a significant negative trend, slope -0.036, which matches that of the bam.   

```{r}
dat_cr <- with(dat, cencorreg(lognut, cens, dec_date,
                              verbose = 0,
                              LOG = FALSE))
summary(dat_cr)
```


## GAM w/censoring  

This slope should be the same as that from censored regression - which in this case should be the same as from simple linear regression.  


## GAM w/seasonality only  

This slope matches that of the simple regression model, -0.041. Seasonality term not significant. R^2 0.21.  

```{r}
dat_gam_seas <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = dat)
summary(dat_gam_seas)
acf(residuals(dat_gam_seas), plot = FALSE)[1]
```


## GAM w/cens + seasonality  

Same slope as both other models that incorporated censoring: -0.037. Seasonal term again non-significant. R^2 again 0.21.    

```{r}
# need a matrix with nutrient and censoring values
dat_gam_censseas <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = dat,
                  method = "REML")
summary(dat_gam_censseas)
acf(residuals(dat_gam_censseas), plot = FALSE)[1]
```


***  


# GNDPCWQ {.tabset}  

spcond_median seems to be decreasing (?)  

## Simple Regression  

```{r}
gndpc_lm <- lm(param ~ dec_date, data = gndpc)
summary(gndpc_lm)
acf(residuals(gndpc_lm))[1]
```

Can see some seasonality in the residuals.  


## Simple GAM  

Should see same results as simple linear regression.  


## GAM w/seasonality  

Hopefully we get the same slope, but are accounting for seasonality.  

Seasonal term significant. Slope -0.477, st. error 0.080. R^2 0.50.  
From linear model, slope was -0.4892, st. error 0.1079, R^2 0.097. Seasonal GAM improved R^2 and standard error; didn't really change slope.  

Substantial autocorrelation (though it seems that accounting for seasonality took care of some of that).  

```{r}
gndpc_gam_seas <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = gndpc)
summary(gndpc_gam_seas)
acf(residuals(gndpc_gam_seas))[1]
pacf(residuals(gndpc_gam_seas))
```


## GAM w/AR  

Autocorrelation only. Should again get same slope; probably wider confidence intervals by accounting for autocorrelation.  



## GAM w/AR + seasonality  

The ultimate model.  

```{r}
gndpc_gam_ar <- gamm(param ~ dec_date + s(month, bs = "cc", k = 12),
                     data = gndpc,
                     correlation = corAR1(form = ~1|month),
                     method = "REML")
summary(gndpc_gam_ar$gam)
```




# GNDBCWQ {.tabset}  

cdepth_median seems to be increasing  

## Simple Regression  

```{r}
gndbc_lm <- lm(param ~ dec_date, data = gndbc)
summary(gndbc_lm)
acf(residuals(gndbc_lm))[1]
pacf(residuals(gndbc_lm))
```

## Simple GAM  

Should see same results as simple linear regression.  


## GAM w/seasonality  

Hopefully we get the same slope, but are accounting for seasonality. 

Seasonal term significant. Slope 0.032, st. error 0.002. R^2 0.76.  
From linear model, slope was 0.033, st. error 0.003, R^2 0.50. Seasonal GAM improved R^2 greatly and (slightly) standard error; didn't really change slope. 

Some autocorrelation in the residuals but not as much as I'd thought.  

```{r}
gndbc_gam_seas <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = gndbc)
summary(gndbc_gam_seas)
acf(residuals(gndbc_gam_seas))[1]
```

 
## GAM w/AR  

Autocorrelation only. Should again get same slope; probably wider confidence intervals by accounting for autocorrelation.  


## GAM w/AR + seasonality  

The ultimate model.  




# NIWOLWQ {.tabset}  

do-pct - doesn't seem to be changing (visually) 

## Simple Regression  

```{r}
niwol_lm <- lm(param ~ dec_date, data = niwol)
summary(niwol_lm)
plot(residuals(niwol_lm))
acf(residuals(niwol_lm, type = "pearson"))
acf(residuals(niwol_lm, type = "pearson"))[1]
```


## Simple GAM  

Should see same results as simple linear regression.  


## GAM w/seasonality  

Hopefully we get the same slope, but are accounting for seasonality.  

Seasonal term significant. Slope 0.0036, st. error 0.002, slope slightly significant now - p = 0.046. R^2 0.35.  
From linear model, slope was 0.004, st. error 0.002, R^2 0.017. Seasonal GAM greatly improved R^2. Didn't change standard error but did move slope to significant (p from linear model was 0.117), interestingly. Wonder if that will change when autocorrelation comes into play.   

```{r}
niwol_gam_seas <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = niwol)
summary(niwol_gam_seas)
acf(residuals(niwol_gam_seas))[1]
```



## GAM w/AR  

Autocorrelation only. Should again get same slope; probably wider confidence intervals by accounting for autocorrelation.  


## GAM w/AR + seasonality  

The ultimate model.  



***  
***  