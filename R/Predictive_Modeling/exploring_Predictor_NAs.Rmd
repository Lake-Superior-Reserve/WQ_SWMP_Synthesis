---
title: "NAs in predictors"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)

library(tidyverse)
library(skimr)
```

In developing the predictive model for chl/do trends, specifically in conducting PCAs of predictors, I've noticed there are missing values in the predictor data frame. When doing PCAs, I replaced missing values with 0 after centering and scaling the non-missing values. However, because of future model selection, we need to figure out what's really going on with these and how to deal with them.  

1.  How many are there, by predictor?  Trend calculations vs. seasonality?  
2.  Which stations are affected? (e.g. is it ice stations, or ....?)  

If we can find out where they are, maybe we can fix it.  

Note, I suspect some of these are no23 trends from reserves that measure no2 and no3 separately, so the no23 column of the data frame is probably full of NAs.  

## Read in predictors  

This data frame has been compiled from many different sources - another thing I need to do is make a roadmap of everything that's gone into it.  

```{r}
# wq, met, nut trends; overall medians; overall seasonal amplitudes
# station is 5-letter version
preds_all <- read.csv(here::here("Data", "compiled_predictors.csv"))

# all original trend calculations; will need to trim this
# only keep chla and do trends
# chla trend should already be present in preds_all though
# station is 7-8 letter version
responses <- read.csv(here::here("Outputs", "calculated_trends",
                                 "long-term-trends.csv"))

# trends in seasonal amplitudes
# station is 7-8 letter version
seas_trends <- readRDS(here::here("Outputs", "calculated_trends", 
                               "seasonal_amplitude_trends.rds"))

```

```{r}
skim(preds_all)
```

Missing some trends:  

-  chla_trend, 4 missing  
-  po4f_trend, 8 missing  
-  nh4f_trend, 6 missing  
-  no23f_trend, 16 missing  
-  6 missing of MET predictors - maybe a data frame didn't join correctly, or time periods didn't line up?: atemp, wspd, maxwspd, totprcp, dailyPAR, atemp_trend, dailyPAR_trend, precp_trend


```{r}
skim(responses)
```

42 trends missing; this could be in more parameters than just our target ones and may not be any more useful than the preds_all data frame.  

```{r}
skim(seas_trends)
```

Woo-hoo, seasonal trends are 100% present! Seasonal amplitudes weren't missing from the preds_all data frame either!  


So generally what we're missing is trends, and some MET medians.  


## MET missingness  

Starting here because this is probably the easiest.  

```{r}
met_goofs <- preds_all |> 
  filter(is.na(atemp_median))

skim(met_goofs)
```

Yep, all of those MET missings are related.  

```{r}
met_goofs |> 
  select(reserve, station, met_station) |> 
  distinct() |> 
  gt::gt()
```

Alrighty, it's LKS and SOS, without associated met stations. Need to follow up there - find the script where I pulled in MET stations, and find out what went wrong.  

Looks like their primary MET stations haven't been installed for 10 years - LKS only has data from Sept 2013 on, and SOS from 2017 on (though I recall SOS moving a weather station, so they may have data from earlier? Do we need to exlude their sites???)  Should be able to muscle LKS's weather station, assuming group is okay with us making the exception to the 10 year rule (I think it's justifiable).  


## Trends - Nutrients  

Happy to report all trends are present for WQ parameters. Here's what's missing for nutrients:  

-  chla_trend, 4 missing  
-  po4f_trend, 8 missing  
-  nh4f_trend, 6 missing  
-  no23f_trend, 16 missing   

```{r}
nut_goofs <- preds_all |> 
  select(reserve, station, chla_trend, po4f_trend, nh4f_trend, no23f_trend) |> 
  filter(is.na(chla_trend) | is.na(po4f_trend) | is.na(nh4f_trend) | is.na(no23f_trend))

gt::gt(nut_goofs)
```

```{r}
nut_goofs2 <- nut_goofs |> 
  pivot_longer(chla_trend:no23f_trend,
               names_to = "param",
               values_to = "value") |> 
  filter(is.na(value)) |> 
  select(station, param) |> 
  arrange(station, param) |> 
  summarize(.by = station,
            params = paste(unique(param), collapse = "; "))
```


Missing NO23 trends:  
-  HUD  - missing the data; probably quantify no2 and no3 separately  
-  NAR  
-  NOC (2 stations)  
-  OWC  - most of 2018 and 2020 are missing; maybe that's the problem?  
-  SFB (1 station)  - missing a lot of data; surprising that only 1 station didn't get calculated  
-  WQB  

Missing chl trends:  
-  OWC (1)  - BR - this doesn't make any sense; looks like plenty of data
-  WQB (3)  

Missing PO4 trends:  
-  NAR (2)  
-  NOC (3)  
-  WQB (3)  

Missing NH4 trends:  
-  NAR (2)  
-  NOC (3)  
-  WQB (1)  


There are ice stations at WQB, OWC, and maybe NAR - wonder if there's too much missing data to fit the seasonal curve and calculate trends? Probably should look back at time series plots.  


Looks like WQB is missing all po4, nh4, and no23 data from 2009-2011 - must have been flagged suspect or rejected due to lab reasons. chla is spotty during this time period too. I wonder if this messed up the GAMs.   

NAR is missing all po4, nh4, and no23 data from 2008-sept 2013 - lab thing?? Possibly the same issue that affected WQB? Chl is also spotty during this time period, though trends were successfully calculated.  

NOC is missing some po4, nh4, and no23 data (all of 2013 at 3 stations), but not enough that I can see why the trend wasn't calculated at 3 sites - unless a full year missing in the middle is enough?  
