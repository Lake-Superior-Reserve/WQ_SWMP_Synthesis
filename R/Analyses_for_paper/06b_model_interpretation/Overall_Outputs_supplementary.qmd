---
title: "Graphs and Tables of averaged model outputs (deltas < 2 and 6)"
output-file: "2024-08-08 Model Outputs supplementary"
date: today
format: 
  pdf:
    toc: true
    fig-width: 6
    fig-height: 4
  html:
    toc: true
    toc-location: left
    embed-resources: true
    fig-width: 7
    fig-height: 5
echo: false
warning: false
message: false
error: true
---

# Overview  


This file contains information on model outputs for our three key responses, using model-averaging (full model method) on models with delta AICc < 2 and < 6 from the top model. delta < 4 will be discussed in the main paper, and this file is for supplementary information. delta < 4 models may be included here for comparison.  


## Some notes on coefficients and graphics  

Standardized coefficients, as in the coefficient plots and the left columns of the coefficient tables, are interpreted on a scale of standard deviations: one standard deviation in [predictor] is expected to be associated with a [coefficient]-standard deviation change in [response].  

In the tables, coefficients have also been back-transformed to the units of the predictors. We must keep in mind that the predictor units are generally not on the scales of variable measurements (nutrient and turbidity trends are "trend in the log-transformed [variable]", and nutrient and turbidity medians have also been log-transformed. precipitation trend is "trend in square-root of precipitation"). 


```{r}
library(tidyverse)
library(nlme)
library(MuMIn)
library(gt)
library(patchwork)
```

```{r}
# get needed data frames and source functions
chl_in <- load(here::here("Outputs",
                "06_model_selection",
                "R_objects",
                "chla_post-averaging.RData"))
chl_list <- mget(chl_in)
rm(list = chl_in)


domgl_in <- load(here::here("Outputs",
                "06_model_selection",
                "R_objects",
                "domgl_post-averaging.RData"))
domgl_list <- mget(domgl_in)
rm(list = domgl_in)


doLT2_in <- load(here::here("Outputs",
                "06_model_selection",
                "R_objects",
                "doLT2_post-averaging.RData"))
doLT2_list <- mget(doLT2_in)
rm(list = doLT2_in)


source(here::here("R",
                  "Analyses_for_paper",
                  "06_model_selection",
                  "060_predicting_functions.R"))
```


```{r}
# compile coefficients

# add standardized tables to the lists

# chl, delta 2
swdf <- data.frame(sw_all = sw(chl_list$mod_avgd2)) |> 
  rownames_to_column("predictor")
chl_list$coeffs_stnd_d2 <- data.frame(summary(chl_list$mod_avgd2)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))

# chl, delta 6
swdf <- data.frame(sw_all = sw(chl_list$mod_avgd6)) |> 
  rownames_to_column("predictor")
chl_list$coeffs_stnd_d6 <- data.frame(summary(chl_list$mod_avgd6)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))


# domgl, delta 2
swdf <- data.frame(sw_all = sw(domgl_list$mod_avgd2)) |> 
  rownames_to_column("predictor")
domgl_list$coeffs_stnd_d2 <- data.frame(summary(domgl_list$mod_avgd2)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))

# domgl, delta 6
swdf <- data.frame(sw_all = sw(domgl_list$mod_avgd6)) |> 
  rownames_to_column("predictor")
domgl_list$coeffs_stnd_d6 <- data.frame(summary(domgl_list$mod_avgd6)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))


# doLT2, delta 2
swdf <- data.frame(sw_all = sw(doLT2_list$mod_avgd2)) |> 
  rownames_to_column("predictor")
doLT2_list$coeffs_stnd_d2 <- data.frame(summary(doLT2_list$mod_avgd2)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))

# doLT2, delta 6
swdf <- data.frame(sw_all = sw(doLT2_list$mod_avgd6)) |> 
  rownames_to_column("predictor")
doLT2_list$coeffs_stnd_d6 <- data.frame(summary(doLT2_list$mod_avgd6)$coefmat.full) |> 
    rownames_to_column("term") |> 
    mutate(ci_low = Estimate - 1.96*Adjusted.SE,
           ci_high = Estimate + 1.96*Adjusted.SE,
           term = str_remove(term, "cond\\("),
           term = str_remove(term, "\\)")) |> 
    left_join(swdf, by = c("term" = "predictor")) |> 
    filter(!str_starts(term, "\\(Int")) |> 
    arrange(sw_all) |> 
    mutate(term = fct_inorder(term))



# while we're in this step,
# back-transform coefficients to original units:
# both the coefficient and standard error can be
# back-transformed by multiplying by (st.dev(Y)/ st.dev(X))


# chl, and extract information on importance
# delta 2
coeffs_chl_d2 <- chl_list$coeffs_stnd_d2 |> 
  mutate(model = "Chl a trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_chl <- data.frame("n.models" = attributes(chl_list$coeffs_stnd_d2$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_chl_d2 <- full_join(coeffs_chl_d2, nmods_chl, by = "term")
# delta 6
coeffs_chl_d6 <- chl_list$coeffs_stnd_d6 |> 
  mutate(model = "Chl a trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_chl <- data.frame("n.models" = attributes(chl_list$coeffs_stnd_d6$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_chl_d6 <- full_join(coeffs_chl_d6, nmods_chl, by = "term")


# back-transform
sd_y <- chl_list$dat_sds$chla_trend
transform_mults <- chl_list$dat_sds |> 
    pivot_longer(cols = everything(),
                 names_to = "term",
                 values_to = "sd_x") |> 
    mutate(trans_mult = sd_y / sd_x)
coeffs_chl_d2 = left_join(coeffs_chl_d2, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)
coeffs_chl_d6 = left_join(coeffs_chl_d6, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)

# coeffs_chl |>
#     arrange(desc(sw)) |>
#     select(term, Estimate, Estimate.natural) |>
#     mutate(across(c(Estimate, Estimate.natural),
#                   \(x) round(x, 4))) |>
#     gt::gt()


# domgl
# delta 2
coeffs_domgl_d2 <- domgl_list$coeffs_stnd_d2 |> 
  mutate(model = "DO mg/L trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_domgl <- data.frame("n.models" = attributes(domgl_list$coeffs_stnd_d2$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_domgl_d2 <- full_join(coeffs_domgl_d2, nmods_domgl, by = "term")

# delta 6
coeffs_domgl_d6 <- domgl_list$coeffs_stnd_d6 |> 
  mutate(model = "DO mg/L trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_domgl <- data.frame("n.models" = attributes(domgl_list$coeffs_stnd_d6$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_domgl_d6 <- full_join(coeffs_domgl_d6, nmods_domgl, by = "term")

# back-transform
sd_y <- domgl_list$dat_sds$domgl_trend
transform_mults <- domgl_list$dat_sds |> 
    pivot_longer(cols = everything(),
                 names_to = "term",
                 values_to = "sd_x") |> 
    mutate(trans_mult = sd_y / sd_x)
coeffs_domgl_d2 = left_join(coeffs_domgl_d2, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)
coeffs_domgl_d6 = left_join(coeffs_domgl_d6, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)



# do<2
# delta 2
coeffs_doLT2_d2 <- doLT2_list$coeffs_stnd_d2 |> 
  mutate(model = "DO < 2 trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_doLT2 <- data.frame("n.models" = attributes(doLT2_list$coeffs_stnd_d2$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_doLT2_d2 <- full_join(coeffs_doLT2_d2, nmods_doLT2, by = "term")

# delta 6
coeffs_doLT2_d6 <- doLT2_list$coeffs_stnd_d6 |> 
  mutate(model = "DO < 2 trend",
         sw = as.numeric(sw_all)) |> 
  select(-sw_all)
nmods_doLT2 <- data.frame("n.models" = attributes(doLT2_list$coeffs_stnd_d6$sw_all)$n.models) |> 
  tibble::rownames_to_column("term")
coeffs_doLT2_d6 <- full_join(coeffs_doLT2_d6, nmods_doLT2, by = "term")

# back-transform
sd_y <- doLT2_list$dat_sds$doLT2_trend
transform_mults <- doLT2_list$dat_sds |> 
    pivot_longer(cols = everything(),
                 names_to = "term",
                 values_to = "sd_x") |> 
    mutate(trans_mult = sd_y / sd_x)
coeffs_doLT2_d2 = left_join(coeffs_doLT2_d2, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)
coeffs_doLT2_d6 = left_join(coeffs_doLT2_d6, transform_mults) |> 
    mutate(Estimate.natural = Estimate * trans_mult,
           Adjusted.SE.natural = Adjusted.SE * trans_mult)



rm(nmods_chl, nmods_domgl, nmods_doLT2,
   sd_y, transform_mults)
```



# Coefficient summaries  

## Chl a  


**Global model:**  

```{r}
formula(chl_list$mod_chl)
```

That formula doesn't show it, but `Reserve` was included as a random effect.  

**# Candidate models:**  `r format(2^(length(fixef(chl_list$mod_chl)) - 1), big.mark = ",", scientific = FALSE)`

**# models in top set (delta < 2):**  `r nrow(chl_list$top_modsd2)`  
**# models in top set (delta < 6):**  `r nrow(chl_list$top_modsd6)`


```{r}
#| fig-width: 7
#| fig-height: 4

p2 <- graph_coeffs(chl_list$coeffs_stnd_d2, title_param = "Chl a trend") +
    labs(subtitle = "delta < 2")

p6 <- graph_coeffs(chl_list$coeffs_stnd_d6, title_param = "Chl a trend") +
    labs(subtitle = "delta < 6")

p2 + p6
```

We have the same major 3 predictors for chl trend as we did with delta < 4: phosphate trend (positive association), turbidity trend (positive association), and ammonia trend (negative association). Spcond trend, median chl a, and precip trend are of higher importance with the delta < 2 model. Using delta < 6 seems to shrink coefficients, sometimes fairly substantially.  


```{r}
table_coeffs(coeffs_chl_d2, title_param = "Chl a trend", delta = 2)
```


```{r}
table_coeffs(coeffs_chl_d6, title_param = "Chl a trend", delta = 6)
```

## DO mg/L  

**Global model:**  

```{r}
formula(domgl_list$mod_domgl)
```


**# Candidate models:**  `r format(2^(length(coef(domgl_list$mod_domgl)) - 1), big.mark = ",", scientific = FALSE)`

**# models in top set (delta < 2):**  `r nrow(domgl_list$top_modsd2)`  
**# models in top set (delta < 6):**  `r nrow(domgl_list$top_modsd6)`


```{r}
#| fig-width: 7
#| fig-height: 4

p2 <- graph_coeffs(domgl_list$coeffs_stnd_d2, title_param = "DO mg/L trend") +
    labs(subtitle = "delta < 2")

p6 <- graph_coeffs(domgl_list$coeffs_stnd_d6, title_param = "DO mg/L trend") +
    labs(subtitle = "delta < 6")

p2 + p6
```

The top 4 predictors stay the same, with similar coefficients, but importance changes slightly. Outputs are more similar for DO mg/L delta 2 vs. 6 than they were for the chl model using different deltas.  



```{r}
table_coeffs(coeffs_domgl_d2, title_param = "DO mg/L trend", delta = 2)
```



```{r}
table_coeffs(coeffs_domgl_d6, title_param = "DO mg/L trend", delta = 6)
```


## Proportion of time DO < 2 mg/L  

**Global model:**  

```{r}
formula(doLT2_list$mod_doLT2)
```


**# Candidate models:**  `r format(2^(length(coef(doLT2_list$mod_doLT2)) - 1), big.mark = ",", scientific = FALSE)`

**# models in top set (delta < 2):**  `r nrow(doLT2_list$top_modsd2)`  
**# models in top set (delta < 6):**  `r nrow(doLT2_list$top_modsd6)`



```{r}
#| fig-width: 7
#| fig-height: 4

p2 <- graph_coeffs(doLT2_list$coeffs_stnd_d2, title_param = "\ntrend in proportion of DO readings < 2 mg/L") +
    labs(subtitle = "delta < 2")

p6 <- graph_coeffs(doLT2_list$coeffs_stnd_d6, title_param = "\ntrend in proportion of DO readings < 2 mg/L") +
    labs(subtitle = "delta < 6")

p2 + p6
```


The top three predictors stay the same, as do the moderate ones, though importance shifts around a bit.    


```{r}
table_coeffs(coeffs_doLT2_d2, title_param = "DO < 2 trend", delta = 2)
```


```{r}
table_coeffs(coeffs_doLT2_d6, title_param = "DO < 2 trend", delta = 6)
```

