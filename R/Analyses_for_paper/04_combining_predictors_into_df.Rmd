---
title: "Combining predictors"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 8.5,
                      fig.width = 8)

# packages
library(tidyverse)
library(NADA2)  # for cfit - Kaplan Meier estimation


# parameters and columns to keep
params_wq <- c("temp_median", "spcond_median", 
               "turb_median")
params_nut <- c("chla_n", "chla_n_cens",
                "nh4f", "nh4f_cens",
                "no23f", "no23f_cens",
                "po4f", "po4f_cens")
params_met <- c("atemp_median", "wspd_median",
                "maxwspd_median", "totprcp_total",
                "dailyPAR_median")
params_trends <- c("temp_median", "spcond_median", "turb_median",
                   "chla_n", "po4f", "nh4f", "no23f",
                   "atemp_median", "dailyPAR_median",
                   "sqrt_precp_total")


# homemade function to use NADA2::cfit and pull out the Kaplan-Meier median
extract_cens_median <- function(df, nut, nut_cens){

  # nut and nut_cens should be entered as character strings
  
  tmp <- df[c(nut, nut_cens)]
  names(tmp) <- c("nut", "nut_cens")

  station <- unique(df$station)
  param <- nut
    
  tmp <- tmp |> 
    na.omit() |> 
    mutate(nut = case_when(nut <=0 ~ 0.0001,
                           .default = nut)) 
  
  if(nrow(tmp) < 5) return(list(station = station,
                                param = param,
                                KMmedian = NA,
                                PctND = NA))
  if(sum(tmp$nut_cens == 0) < 2) return(list(station = station,
                                param = param,
                                KMmedian = NA,
                                PctND = NA))
  
  tmp_fit <- cfit(tmp$nut, tmp$nut_cens, Cdf = FALSE, printstat = FALSE)
  KMmedian <- tmp_fit$KMmedian
  
  KMmedian <- ifelse(is.character(KMmedian),
                     as.numeric(str_remove(KMmedian, "<")),
                     KMmedian)
  
  PctND <- tmp_fit$PctND
  
  return(list(station = station,
              param = param,
              KMmedian = KMmedian,
              PctND = PctND))
}

```

Need to bring everything together: slopes and long-term medians.  

# Data import  

Read in wq, met, nut data. Only keep key parameters (and medians). Calculate long-term medians for every monthly median. Use Kaplan-Meier methods on censored data (NUT). Bind WQ and NUT stations. Find primary SWMP MET station for each reserve and bind to the wq/nut stations on reserve.  

```{r load-data}
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))  
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyMET.RData")) 

load(here::here("Outputs", "calculated_trends", "long-term-trends.RData"))
load(here::here("Outputs", "calculated_trends", "seasonal_characterization.RData"))

mdat <- readr::read_csv(here::here("helper_files", "sampling_stations.csv"))
```

Determine primary SWMP MET station at each reserve. Some reserves have more than one; select the one with the longest time series.  

```{r}
primary_met <- mdat |> 
  filter(isSWMP == "P",
         str_ends(`Station Code`, "met")) |> 
  select(met_stn = `Station Code`) |> 
  mutate(reserve = substr(met_stn, 1, 3),
         station = substr(met_stn, 1, 5))  
  
# use reserve column to join these to other stns
# station to match with trends table

# reserves_with_2 <- janitor::get_dupes(primary_met, reserve)
# 
# trends_met |> 
#   filter(station %in% reserves_with_2$met_stn) |> 
#   select(station, ts_start, ts_end, ts_length, n_points) |> 
#   distinct() |> 
#   arrange(station, ts_start) |> 
#   View()

# only one met station per reserve in the trends file
# so just choose based on the trends file

primary_met <- primary_met |> 
  filter(met_stn %in% unique(trends_met$station))
```


```{r select-filter-data}
# trends
trnds <- bind_rows(trends_df, trends_met, trends_nut) |> 
  mutate(reserve = substr(station, start = 1, stop = 3),
         station = substr(station, start = 1, stop = 5)) |> 
  filter(parameter %in% params_trends) |> 
  mutate(parameter = str_remove(parameter, "_median"),
         parameter = case_when(parameter == "sqrt_precp_total" ~ "precp",
                               parameter == "chla_n" ~ "chla",
                               .default = parameter),
         parameter = paste0(parameter, "_trend")) |> 
  select(reserve, station, parameter, Slope)

# bind together
trnds_water <- trnds |> 
  filter(parameter %in% c("temp_trend", "spcond_trend", "turb_trend",
                          "chla_trend", "po4f_trend", "nh4f_trend",
                          "no23f_trend")) |> 
  pivot_wider(id_cols = c(reserve, station),
              names_from = parameter,
              values_from = Slope)

trnds_met <- trnds |> 
  filter(parameter %in% c("atemp_trend", "dailyPAR_trend", "precp_trend")) |> 
  pivot_wider(id_cols = c(reserve, station),
              names_from = parameter,
              values_from = Slope) |> 
  select(-station)


# wq, nut, met data
# only keep stations with long-term trend calculations
wq <- wq |> 
  mutate(reserve = substr(station, start = 1, stop = 3),
         station = substr(station, start = 1, stop = 5)) |> 
  filter(station %in% unique(trnds_water$station)) |> 
  select(reserve, station, 
         year, month,
         all_of(params_wq))

nut <- nut |> 
  mutate(reserve = substr(station, start = 1, stop = 3),
         station = substr(station, start = 1, stop = 5)) |> 
  filter(station %in% unique(trnds_water$station)) |> 
  select(reserve, station, 
         year, month,
         all_of(params_nut))  

met <- met |> 
  mutate(reserve = substr(station, start = 1, stop = 3)) |> 
  filter(station %in% unique(primary_met$met_stn)) |> 
  select(reserve, station, 
         year, month,
         all_of(params_met)) |> 
  rename(met_station = station)


# seasonality  
seas <- seasonal_by_stn |> 
  filter(parameter %in% c("temp_median", "chla_n", "do_mgl_median")) |> 
  mutate(parameter = case_match(parameter,
                                "chla_n" ~ "chla",
                                "do_mgl_median" ~ "do_mgl",
                                "temp_median" ~ "temp"),
         station = substr(station, 1, 5)) |>  
  select(station, parameter, median_norm_ampl) |> 
  filter(station %in% unique(trnds_water$station)) |> 
  pivot_wider(names_from = parameter,
              values_from = median_norm_ampl,
              names_glue = "{parameter}_seas_ampl")

# latitude - only for wq stations for now, since nut stns are linked to wq
lat_wq <- mdat |> 
  janitor::clean_names() |> 
  select(station_full = station_code,
         latitude) |> 
  mutate(station_full = trimws(station_full),
         reserve = substr(station_full, 1, 3),
         station = substr(station_full, 1, 5)) |> 
  filter(str_ends(station_full, "wq"),
         station %in% unique(trnds_water$station)) |> 
  select(reserve, station, latitude)
  

```


```{r calc-medians}
# wq
wq_medians <- wq |> 
  summarize(.by = c(reserve, station),
            across(temp_median:turb_median, function(x) median(x, na.rm = TRUE)))

# met
met_medians <- met |> 
  summarize(.by = c(reserve, met_station),
            across(atemp_median:dailyPAR_median, function(x) median(x, na.rm = TRUE)))


# nutrients more involved
nut_values <- c("chla_n", "nh4f", "no23f", "po4f")
nut_censoreds <- paste0(nut_values, "_cens")

nut_split <- nut |> 
  split(nut$station)

nut_KMs <- map(nut_split, 
               function(X) map2(nut_values, nut_censoreds,
                                ~extract_cens_median(X, .x, .y )) ) |> 
  bind_rows()

nut_medians <- nut_KMs |> 
  select(station, param, KMmedian) |>
  pivot_wider(id_cols = station,
              names_from = param,
              names_glue = "{param}_median",
              values_from = KMmedian) |> 
  mutate(reserve = substr(station, start = 1, stop = 3)) |> 
  relocate(reserve)
```

```{r join-water-values}
water_medians <- left_join(wq_medians, nut_medians,
                           by = c("reserve", "station"))

# this join will cut out stations where trends weren't calculated
water_all <- left_join(trnds_water, water_medians,
                       by = c("reserve", "station")) |> 
  left_join(lat_wq, by = c("reserve", "station")) |> 
  left_join(seas, by = "station")

met_all <- left_join(met_medians, trnds_met,
                     by = "reserve")

all_predictors <- left_join(water_all, met_all,
                            by = "reserve") |> 
  relocate(met_station, .after = station)

write.csv(all_predictors, here::here("Data", "compiled_predictors.csv"),
          row.names = FALSE,
          na = "")
```