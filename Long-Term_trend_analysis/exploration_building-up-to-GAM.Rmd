---
title: "Long-Term Trend Analyses - GAM testing"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)
```

```{r}
library(dplyr)
library(lubridate)
library(broom)
library(mgcv)
```


Trying to see if I can really run the GAM that I want to run to incorporate everything:  

-  linear time trend  
-  seasonal cycling  
-  autocorrelation of errors  
-  censored data  

Will use decimal date, so trends will be per year.  

# Data  

Will work with a few parameter/station combos; all from aggregated monthly files:  

**Nutrients**:  

-  `cbmipnut` PO4 - seems to have a negative trend  
-  `cbvginut` NO23 - MDL increases; looks like the nutrient itself probably doesn't, and I want to see what the GAM gives us.  
-  `gndhsnut` NH4F - seems to be decreasing, even with decreasing MDL.  


**Water Quality**:  

-  `gndpcwq` spcond_median seems to be decreasing (?)  
-  `gndbcwq` - cdepth_median seems to be increasing  
-  `niwolwq` - do-pct - doesn't seem to be changing (visually anyway)  


```{r}
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyNUT.RData"))
load(here::here("Data", "QAQCd_monthly_byType", "SWMP_monthlyWQ.RData"))

stns <- c("cbmipnut", "cbvginut", "gndhsnut",
          "gndpcwq", "gndbcwq", "niwolwq")

nut <- filter(nut, station %in% stns) %>% 
  mutate(dec_date = decimal_date(ymd(paste(year, month, "15", sep = "-"))))
wq <- filter(wq, station %in% stns) %>% 
  mutate(dec_date = decimal_date(ymd(paste(year, month, "15", sep = "-"))))

# nut data sets  
cbmip <- filter(nut, station == "cbmipnut") %>% 
  select(dec_date, 
         year,
         month,
         nut = po4f,
         cens = po4f_cens) %>% 
  mutate(lognut = log(nut),
         cens2 = case_when(cens == 0 ~ lognut,    # extra censoring column for gam
                           cens == 1 ~ -Inf))

cbvgi <- filter(nut, station == "cbvginut") %>% 
  select(dec_date, 
         year,
         month,
         nut = no23f,
         cens = no23f_cens) %>% 
  mutate(lognut = log(nut),
         cens2 = case_when(cens == 0 ~ lognut,    # extra censoring column for gam
                           cens == 1 ~ -Inf))

gndhs <- filter(nut, station == "gndhsnut") %>% 
  select(dec_date, 
         year,
         month,
         nut = nh4f,
         cens = nh4f_cens) %>% 
  mutate(lognut = log(nut),
         cens2 = case_when(cens == 0 ~ lognut,    # extra censoring column for gam
                           cens == 1 ~ -Inf))


# wq data sets
gndpc <- filter(wq, station == "gndpcwq") %>% 
  select(dec_date, 
         year,
         month,
         param = spcond_median)

gndbc <- filter(wq, station == "gndbcwq") %>% 
  select(dec_date, 
         year,
         month,
         param = cdepth_median)

niwol <- filter(wq, station == "niwolwq") %>% 
  select(dec_date, 
         year,
         month,
         param = cdepth_median)
```



# Simple linear regression {.tabset}  

See if trends get picked up here regardless.  

## nut  

### untransformed  

```{r}
cbmip1 <- lm(nut ~ dec_date, data = cbmip)
cbvgi1 <- lm(nut ~ dec_date, data = cbvgi)
gndhs1 <- lm(nut ~ dec_date, data = gndhs)
```

```{r}

```


### log transformed  

```{r}
cbmip1b <- lm(lognut ~ dec_date, data = cbmip)
cbvgi1b <- lm(lognut ~ dec_date, data = cbvgi)
gndhs1b <- lm(lognut ~ dec_date, data = gndhs)
```

```{r}

```


## wq  

```{r}
gndpc1 <- lm(param ~ dec_date, data = gndpc)
gndbc1 <- lm(param ~ dec_date, data = gndbc)
niwol1 <- lm(param ~ dec_date, data = niwol)
```




# Censored regression (nut only)  

See if the nutrient trends are/aren't picked up when we ignore all the other pieces (seasonality/autocorrelation in particular).  

These are log-transformed by default. Compare them to log values.  CBM's is throwing an error for some reason. The error message is that there is no "y" argument. (???) Additionally, no censored values, so 'gofTest' was called.  

```{r}
library(NADA2)

with(gndhs, cencorreg(nut, cens, dec_date))
with(cbvgi, cencorreg(nut, cens, dec_date))

```

Censored regression correctly eliminates the positive trend from the regular lm for CBV (only looks like it's increasing because the detection limit increased). Coefficient for GNDHS was pretty similar between the two methods.    

# GAM with seasonality  

## nut  

```{r}
cbmip_gam1 <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = cbmip)
summary(cbmip_gam1)
```

Seasonal term is highly significant. Linear trend slope looks the same as before, though standard error is a bit smaller.  R^2 went up from about 0.2 to about 0.5.  

```{r}
cbvgi_gam1 <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = cbvgi)
summary(cbvgi_gam1)
```

Remember this is an inaccurate slope due to censoring. It's similar to that of the linear regression. Seasonal term is again significant. R^2 went up from 0.03 to 0.23.  

```{r}
gndhs_gam1 <- gam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                  data = gndhs)
summary(gndhs_gam1)
```

Slope is about the same as linear model. Seasonal term not significant. R^2 0.21 vs. 0.20 from linear model. Seasonal term doesn't impact the output in a negative way though; it's just not needed to explain this particular model.  

Maybe this is how we can "test" for seasonality???

## wq  

```{r}
gndpc_gam1 <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = gndpc)
summary(gndpc_gam1)
```

Seasonal term significant. Slope -0.477, st. error 0.080. R^2 0.50.  
From linear model, slope was -0.4892, st. error 0.1079, R^2 0.097. Seasonal GAM improved R^2 and standard error; didn't really change slope.  

```{r}
gndbc_gam1 <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = gndbc)
summary(gndbc_gam1)
```

Seasonal term significant. Slope 0.032, st. error 0.002. R^2 0.76.  
From linear model, slope was 0.033, st. error 0.003, R^2 0.50. Seasonal GAM improved R^2 greatly and (slightly) standard error; didn't really change slope.  


```{r}
niwol_gam1 <- gam(param ~ dec_date + s(month, bs = "cc", k = 12),
                  data = niwol)
summary(niwol_gam1)
```

Seasonal term significant. Slope 0.006, st. error 0.002, slope slightly significant now - p = 0.046. R^2 0.35.  
From linear model, slope was 0.004, st. error 0.002, R^2 0.017. Seasonal GAM greatly improved R^2. Didn't change standard error but did move slope to significant (p from linear model was 0.117), interestingly. Wonder if that will change when autocorrelation comes into play.    

# GAM with seasonality and censoring (nutrients only)  

mgcv::gam with cnorm family (censored data)  

https://stat.ethz.ch/R-manual/R-devel/library/mgcv/html/cnorm.html  


```{r}
# need a matrix with nutrient and censoring values
cbvgi$lognut_mat <- cbind(cbvgi$lognut, cbvgi$cens2)
cbvgi_gam2 <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = cbvgi,
                  method = "REML")
summary(cbvgi_gam2)
```

Got a similar slope to the censored regression! -0.014 for the GAM; -0.008 for cenreg. Neither statistically significant. Can see from the GAM that seasonality is significant.

```{r}
with(cbvgi, cencorreg(nut, cens, dec_date))
```


```{r}
cbmip$lognut_mat <- cbind(cbmip$lognut, cbmip$cens2)
cbmip_gam2 <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = cbmip,
                  method = "REML")
summary(cbmip_gam2)
```

Similar slope to all that came before with this station. 


```{r}
gndhs$lognut_mat <- cbind(gndhs$lognut, gndhs$cens2)
gndhs_gam2 <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = gndhs,
                  method = "REML")
summary(gndhs_gam2)
```

Again, similar. 


# Summary so far  

I trust the GAM so far. The linear term is similar as the linear model when there's little-to-no censoring. The linear term is similar to the censored regression slope when there *is* censoring (and it turns out to be necessary!); when there isn't censoring, it doesn't affect anything. Seasonality is accounted for if present, and reflected in the R^2 and presumably the confidence intervals. When it's not present, it doesn't hurt anything - slopes and R^2 come out similar to the GAM without a seasonal term.  


# GAM with seasonality and AR1 correlation structure  

How to look at the residual autocorrelation in the first place..... hmmmm.  

Some info in this Gavin Simpson blog post: https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/  

Though from my course I know that ACF and pACF can be wrong if you have missing data, which we most certainly do. Would be better to make a variogram; just need to find the code.  

But here's how to look at acf/pacf of gam output:  

```{r}
acf(cbmip_gam2$residuals)
acf(gndbc_gam1$residuals)
acf(niwol_gam1$residuals)
```


```{r}
library(gstat)
library(sp) # RETIRING OCTOBER 2023
library(ggplot2)
```

```{r}
niw2 <- na.omit(niwol)
#' We can also make a variogram to check for temporal dependency.
MyData2 <- data.frame(resids   = niwol_gam1$residuals, 
                      Time = niw2$dec_date, 
                      Ones = rep(1, nrow(niw2)))
coordinates(MyData2) <- c("Time", "Ones")
MyData2

V1 <- variogram(resids ~ Time,  
                MyData2, 
                # cutoff  = 159,
                cressie = TRUE)
V1

#' Plot the variogram
p <- ggplot()
p <- p + geom_point(data = V1,
                    aes(x = dist, 
                        y = gamma))
p <- p + xlab("Time") + ylab("Semi-variogram")
p <- p + theme(text = element_text(size = 15)) 
p <- p + theme(legend.position="none") 
p
```

```{r}
acf(niwol_gam1$residuals)
pacf(niwol_gam1$residuals) 
```

"The partial autocorrelation at lag k is the correlation that results after removing the effect of any correlations due to the terms at shorter lags." - p. 81, section 4.5.6, Introductory Time Series with R. Via: https://machinelearningmastery.com/gentle-introduction-autocorrelation-partial-autocorrelation/ 
 
That link says "A partial autocorrelation is a summary of the relationship between an observation in a time series with observations at prior time steps with the relationships of intervening observations removed."  

So if I'm interpreting things right: even though that NIW acf plot looks like there's correlation through the first 5 lags, the pacf plot shows that if we remove the correlation from the first lag, we'd have taken care of it.  

```{r}
gndhs2 <- na.omit(gndhs)
#' We can also make a variogram to check for temporal dependency.
MyData2 <- data.frame(resids   = gndhs_gam2$residuals, 
                      Time = gndhs2$dec_date, 
                      Ones = rep(1, nrow(gndhs2)))
coordinates(MyData2) <- c("Time", "Ones")
MyData2

V1 <- variogram(resids ~ Time,  
                MyData2, 
                # cutoff  = 159,
                cressie = TRUE)
V1

#' Plot the variogram
p <- ggplot()
p <- p + geom_point(data = V1,
                    aes(x = dist, 
                        y = gamma))
p <- p + xlab("Time") + ylab("Semi-variogram")
p <- p + theme(text = element_text(size = 15)) 
p <- p + theme(legend.position="none") 
p
```


```{r}
# E3 is pearson residuals from a fitted model using OU dependency
IC2$E3 <- resid(M3.ou, type = "pearson")

#' We can also make a variogram to check for temporal dependency.
MyData2 <- data.frame(E3   = IC2$E3, 
                      Year = IC2$Year - 1005, 
                      Ones = rep(1, nrow(IC2)))
coordinates(MyData2) <- c("Year", "Ones")
MyData2

V1 <- variogram(E3 ~ Year,  
                MyData2, 
                cutoff  = 159,
                cressie = TRUE)
V1

#' Plot the variogram
p <- ggplot()
p <- p + geom_point(data = V1,
                    aes(x = dist, 
                        y = gamma))
p <- p + xlab("Year") + ylab("Semi-variogram")
p <- p + theme(text = element_text(size = 15)) 
p <- p + theme(legend.position="none") 
p
```


Build up the seasonal GAM with gamm and play around with that.  

_gam1 are uncensored, with seasonal term  
_gam2 are censored, with seasonal term

```{r}
gndhs_gam3 <- gamm(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                   data = gndhs)

summary(gndhs_gam3$gam)
# summary(gndhs_gam3$lme)
```

Results are essentially the same as from _gam1.  (very small differences in a couple spots)  


```{r}
cbvgi_gam3 <- gamm(lognut ~ dec_date + s(month, bs = "cc", k = 12),
                   data = cbvgi)

summary(cbvgi_gam3$gam)
# summary(gndhs_gam3$lme)
```

cbvgi is the one where it's the mdl making it look weird. Make sure censoring works in gamm like it does in gam.  

IT DOES NOT. 'gamm' can't work with family cnorm. Guess I need to figure it out in glmmTMB.  

```{r}
# cbvgi_gam4 <- gamm(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
#                    family = cnorm(),
#                    data = cbvgi,
#                    method = "REML")
# summary(cbvgi_gam4$gam)
```

Does bam work with cnorm?  

```{r}
cbvgi_gam4 <- bam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                   family = cnorm(),
                   data = cbvgi,
                   method = "REML")
summary(cbvgi_gam4)
```

...yes it does...

Now how to figure out the autocorrelation?  

```{r}
cbvgi_gam4 <- bam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  discrete = TRUE,
                  data = cbvgi,
                  method = "fREML")
summary(cbvgi_gam4)
```

Can I pull it from the residuals? Or is that circular?  

```{r}
rawresids <- cbvgi_gam4$residuals
attr(rawresids, "censor") <- NULL
acf(rawresids)
acf(rawresids)[1]
gamrho <- acf(rawresids)[1]$acf
```


```{r}
cbvgi_gam5 <- bam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  discrete = TRUE,
                  rho = gamrho,  # from above
                  data = cbvgi,
                  method = "fREML")
summary(cbvgi_gam5)

rawresids <- cbvgi_gam5$residuals
attr(rawresids, "censor") <- NULL

ARresids <- mgcv:::AR.resid(rawresids, rho = cbvgi_gam5$AR1.rho)

plot(ARresids)
acf(ARresids)
```


```{r}
cbvgi_gam4b <- gam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  data = cbvgi,
                  method = "fREML")
summary(cbvgi_gam4b)

rawresids <- cbvgi_gam4b$residuals
attr(rawresids, "censor") <- NULL
acf(rawresids)
acf(rawresids)[1]
gamrho <- acf(rawresids)[1]$acf
```


```{r}
cbvgi_gam5b <- bam(lognut_mat ~ dec_date + s(month, bs = "cc", k = 12),
                  family = cnorm(),
                  discrete = TRUE,
                  rho = gamrho,  # from above
                  data = cbvgi,
                  method = "fREML")
summary(cbvgi_gam5b)

rawresids <- cbvgi_gam5b$residuals
attr(rawresids, "censor") <- NULL

ARresids <- mgcv:::AR.resid(rawresids, rho = cbvgi_gam5$AR1.rho)

plot(ARresids)
acf(ARresids)
```

standardized residuals are what you look at after including AR correlation in the model. Needed to pull an internal function from mgcv in order to calculate them due to the censoring.


uncensored bam, to figure out how to get at the standardized residuals:  
```{r}
testgam <- bam(lognut ~ dec_date + s(month, bs = "cc", k = 12),
               discrete = TRUE,
               rho = 0.26,
               data = cbvgi,
               method = "fREML")
summary(testgam)
plot(residuals(testgam))
plot(testgam$std.rsd)
acf(testgam$std.rsd)
```

Can I make my own standardized residuals? Problem is the residuals here have attributes for censoring, with -Inf involved.... but there are numeric values too, so maybe I can manually divide those by the standard deviation of the residuals?  

```{r}
rawresids <- cbvgi_gam5$residuals
attr(rawresids, "censor") <- NULL

ARresids <- mgcv:::AR.resid(rawresids, rho = cbvgi_gam5$AR1.rho)

plot(ARresids)
acf(ARresids)

resids2 <- scale(rawresids)

gam_stdres <- rawresids / sd(rawresids)

plot(gam_stdres)
acf(gam_stdres)
acf(resids2)

acf(gam_stdres)[1]

 
```


Nope, that doesn't come out the same as the standardized residuals pulled from `testgam$std.rsd`.  

```{r}
rawresids <- residuals(testgam)

gam_stdres <- rawresids / sd(rawresids)

plot(gam_stdres)
acf(gam_stdres)

acf(gam_stdres)[1]
```


# GAM with all of it  